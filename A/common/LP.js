var isYouTubeReady=!1,ytPlayer=null;window.onYouTubeIframeAPIReady=function(){isYouTubeReady=!0,console.log("[DEBUG] YouTube API Ready"),document.dispatchEvent(new Event("youtube_api_ready"))},document.addEventListener("DOMContentLoaded",()=>{if(typeof window.lpEndLoaded=="undefined"||typeof window.viewCountsLoaded=="undefined")throw document.body.innerHTML='<div style="color:red;padding:50px;text-align:center;font-family:sans-serif;"><h1>System Error</h1><p>Required components are missing. Viewer cannot initialize.</p></div>',new Error("Integrity check failed: Components missing.");const e="https://mediamaze.com/json/?",t=[["animate__fadeOut","animate__fadeIn"],["animate__zoomOut","animate__zoomIn"],["animate__slideOutLeft","animate__slideInRight"],["animate__flipOutY","animate__flipInY"],["animate__rotateOut","animate__rotateIn"],["animate__rollOut","animate__rollIn"],["animate__backOutDown","animate__backInDown"],["animate__zoomOutUp","animate__zoomInUp"],["animate__lightSpeedOutRight","animate__lightSpeedInLeft"]];let n={},o=[],a=[],l=0,i=1,s=[],r=-1,c=[],d=0,u=!1,m=!1,p=null,g=!1,y=null;function h(e){return document.getElementById(e)}function f(e,t){const n=h(e);n&&n.addEventListener("click",t)}function v(e,t=!1,n=2e3,o=!1){if(!g||o){const o=h("toast-container");if(o){o.innerHTML="";const a=document.createElement("div");a.className="toast-message"+(t?" big":""),a.innerHTML=e,o.appendChild(a),void a.offsetWidth,a.classList.add("show"),setTimeout(()=>{a.classList.remove("show"),setTimeout(()=>{a.parentNode&&a.parentNode.removeChild(a)},300)},n)}}}function b(e){const t=h("meta-modal");t&&"flex"===t.style.display||v(e)}async function E(e,t){const n=h(t);if(n)try{const t=await fetch(e);t.ok?n.innerHTML=await t.text():console.warn(`[LP] Failed to load ${e}: ${t.status}`)}catch(t){console.warn(`[LP] Error loading ${e}`,t)}}function L(){if(!document.getElementById("youtube-api-script")){const e=document.createElement("script");e.id="youtube-api-script",e.src="https://www.youtube.com/iframe_api";const t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}}function w(){const e=window.location.search||window.location.hash,t=e.replace(/[?#]/g,"").replace(".json","");return t.endsWith("/info")?t.replace("/info",""):t}function I(){const e=window.location.search,t=window.location.hash;return e.includes("/info")||t.includes("#info")}function k(e){if(e){const t=e.meta||{};document.title=t.og_title||t.twitter_title||e.albumTitle||"Photo Album"}}function T(e=0){if(0!==a.length){2===i&&S(1);let n=l+e;n<0?n=a.length-1:n>=a.length&&(n=0),l=n;const o=a[l];h("photo-title").textContent=o.title||"Untitled",h("photo-desc").innerHTML=o.description||"",h("photo-exif").innerHTML="";const s=h("photo-counter");s&&(s.textContent=`${l+1} / ${a.length}`),h("detail-title").textContent=o.title||"Untitled",h("detail-desc").innerHTML=o.description||"";const r=h("detail-exif");r.innerHTML="",o.exif&&Object.entries(o.exif).forEach(([e,t])=>{const n=document.createElement("span");n.className="exif-item",n.textContent=`${e.toUpperCase()}: ${t}`,r.appendChild(n)});const c=h("image-wrapper"),d=Array.from(c.querySelectorAll("img")),u=Math.floor(Math.random()*t.length),[m,p]=t[u],g=document.createElement("img");g.src=o.url,g.alt=o.title,g.style.zIndex="10",g.className=`animate__animated ${p}`,c.appendChild(g),d.forEach(e=>{e.style.zIndex="1",e.className="",e.classList.add("animate__animated",m);const t=()=>{e.parentNode&&e.parentNode.removeChild(e)};e.addEventListener("animationend",t,{once:!0}),setTimeout(t,1100)}),g.addEventListener("animationend",()=>{g.classList.remove(p)},{once:!0})}}function C(){p?x():(v("Slideshow Started (8s)"),p=setInterval(()=>T(1),8e3))}function x(){p&&(clearInterval(p),p=null,v("Slideshow Paused"))}function A(){document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen().catch(e=>console.log(e))}document.addEventListener("mousemove",()=>{document.body.classList.remove("hide-cursor"),y&&clearTimeout(y),document.fullscreenElement&&g&&(y=setTimeout(()=>{document.fullscreenElement&&g&&document.body.classList.add("hide-cursor")},3e3))});function S(e){i=e;const t=h("info-overlay"),n=h("photo-details-modal"),o=h("photo-counter");0===e?(t&&t.classList.add("hidden"),n&&(n.style.display="none"),o&&o.classList.add("hidden"),document.body.classList.remove("info-on")):1===e?(t&&t.classList.remove("hidden"),n&&(n.style.display="none"),o&&o.classList.remove("hidden"),document.body.classList.add("info-on")):2===e&&(t&&t.classList.add("hidden"),n&&(n.style.display="flex"),o&&o.classList.add("hidden"),document.body.classList.add("info-on"))}function M(){S(i>0?0:1)}function P(){0===i?S(1):1===i&&S(2)}function B(){2===i?S(1):1===i&&S(0)}function N(){const e=()=>{m||(m=!0,u&&setTimeout(()=>{u&&_()},50),document.removeEventListener("click",e),document.removeEventListener("keydown",e),document.removeEventListener("touchstart",e))};document.addEventListener("click",e),document.addEventListener("keydown",e),document.addEventListener("touchstart",e)}function _(){if(0===c.length)return;const e=c[d],t=h("music-btn");t&&t.classList.add("music-active"),"mp3"===e.type?(h("audio-element").src=e.url,h("audio-element").play().then(()=>{u||(h("audio-element").pause(),t&&t.classList.remove("music-active"))}).catch(e=>{console.warn("Play blocked")})): "youtube"===e.type&&(isYouTubeReady?ytPlayer?ytPlayer.loadVideoById(e.url.split("v=")[1].split("&")[0]):(ytPlayer=new YT.Player("youtube-player-placeholder",{height:"0",width:"0",videoId:e.url.split("v=")[1].split("&")[0],events:{onReady:e=>{e.target.playVideo(),setTimeout(()=>{u||e.target.pauseVideo()},500)}}})):(document.addEventListener("youtube_api_ready",()=>_(),{once:!0})))}function O(){if(0!==c.length){const e=h("music-btn"),t=h("audio-element");t&&t.pause(),ytPlayer&&"function"==typeof ytPlayer.pauseVideo&&ytPlayer.pauseVideo(),e&&e.classList.remove("music-active"),v("Music Paused")}}function U(){0!==c.length&&(d=(d+1)%c.length,u||(u=!0,m=!0),_(),v(`Playing: ${c[d].title}`))}function R(){0!==c.length&&(u=!u,u?(m=!0,_(),v("Music On")):O())}function q(){g=!g,g?(v("Silent Mode ON (No Toasts)",!1,2e3,!0),document.body.classList.remove("hide-cursor"),y&&clearTimeout(y)):(v("Silent Mode OFF"),document.body.classList.remove("hide-cursor"),y&&clearTimeout(y))}function D(){const e={};o.forEach(t=>{if(!t.categories&&!t.category)return;const n=t.categories||t.category,o=n.split(",").map(e=>e.trim()).filter(e=>e.length>0);o.forEach(t=>{e[t]=(e[t]||0)+1})});const t=h("grid-category-filter");if(t.innerHTML="",0===Object.keys(e).length){const e=document.createElement("option");return e.textContent="No Categories",e.disabled=!0,e.selected=!0,t.appendChild(e),t.disabled=!0,void(s=[])}const n=document.createElement("option");n.value="",n.textContent="All Categories",t.appendChild(n);const a=Object.keys(e).sort((t,n)=>e[n]-e[t]);s=a,a.forEach(n=>{const o=document.createElement("option");o.value=n,o.textContent=`${n} (${e[n]})`,t.appendChild(o)}),t.disabled=!1,t.onchange=()=>{const e=t.value;r=""===e?-1:s.indexOf(e),H(e)},F(Object.keys(e).length)}function F(e){const t=h("meta-categories-display");if(!t)return;let n="";e>0&&(n+=`Categories found: ${e}`),c.length>0&&(""!==n&&(n+=", "),n+=`Music found: ${c.length}`),""===n?t.style.display="none":(t.textContent=n,t.style.display="block")}function j(e){if(0===s.length)return;let t=r+e;if(t<-1)return r=-1,void v("Page Down for Categories");if(t>=s.length)return r=s.length-1,void v("No More Categories");r=t;let n="";-1===r?(n="",v("Showing all photos",!0,2500)):(n=s[r],v(`Category:<br><span style="font-size: 1.3em; font-weight: bold;">${n}</span>`,!0,2500));const o=h("grid-category-filter");o&&(o.value=n),H(n),l=0,T(0)}function z(){x(),a=[...o],r=-1;const e=h("grid-category-filter");e&&(e.value=""),l=0,"flex"===h("grid-modal").style.display&&W(),T(0),v("Album Reset")}function H(e){a=e?o.filter(t=>{if(!t.categories&&!t.category)return!1;const n=t.categories||t.category;return n.split(",").map(e=>e.trim()).includes(e)}):[...o],"flex"===h("grid-modal").style.display&&W()}function W(){const e=h("photo-grid");e.innerHTML="",a.forEach((t,n)=>{const o=document.createElement("div");o.className="photo-item";const a=document.createElement("img");a.src=t.thumbnailUrl||t.url,a.loading="lazy",o.appendChild(a),o.onclick=()=>{l=n,T(0),G()},e.appendChild(o)})}function Y(){G(),h("grid-category-filter").options.length<=1&&D(),W(),h("grid-modal").style.display="flex"}function G(){document.querySelectorAll(".overlay-modal").forEach(e=>e.style.display="none"),2===i&&S(1)}function K(){G(),h("help-modal").style.display="flex"}function J(){G(),h("meta-album-title").textContent=n.albumTitle||"Album",h("meta-created").textContent=n.meta?.created||"N/A",h("meta-note").textContent=n.meta?.note||"";const e=h("meta-og-desc");e&&(e.textContent=n.meta?.og_description||"");const t=c.length>0,o=h("close-meta-btn"),a=h("startup-options");t?(o.style.display="none",a.style.display="flex",setTimeout(()=>{const e=h("btn-view-silent");e&&e.focus()},100)):(o.style.display="block",a.style.display="none"),h("meta-modal").style.display="flex"}function Q(){const e=a[l];if(!e)return;h("admin-json").textContent=w()+".json",h("admin-id").textContent=e.id;const t=`https://mediamaze.com/tony/PhotoAlbum/public/?${w()}#${e.id}`,n=h("admin-url");n.href=t,n.textContent="Link",h("admin-modal").style.display="flex"}async function V(){const t=w();if(S(1),!t)return void(h("main-viewer").innerHTML='<div class="error-message">Error: No album specified in URL.</div>');E("common/LP_first.html","lp-first-content"),E("common/LP_help.html","lp-help-content");try{const i=await fetch(`${e}${t}`);if(!i.ok)throw new Error("Fetch Failed");const s=await i.json();if(s._security&&"Private"===s._security.mode)return void(document.body.innerHTML='<div class="private-overlay"><div class="private-box"><h1>ðŸ”’ Private Album</h1><p>This album is private.</p></div></div>');n=s,k(s),o=(s.photos||[]).filter(e=>e.url&&(!e.mode||"Private"!==e.mode)),a=[...o],s.music&&s.music.length>0?(c=s.music,u=!1,c.some(e=>"youtube"===e.type)&&L(),N()):(h("music-btn").style.display="none",(()=>{const e=document.querySelector('li[data-action="music"]');e&&(e.style.display="none");const t=document.querySelector('li[data-action="next-track"]');t&&(t.style.display="none")})()),D(),a.length>0?T(0):h("main-viewer").innerHTML='<div class="error-message">No photos in album.</div>',I()&&J()}catch(e){console.error(e),h("main-viewer").innerHTML='<div class="error-message">Failed to load album data.</div>'}}f("prev-btn",()=>{T(-1)}),f("next-btn",()=>{T(1)}),f("grid-btn",Y),f("help-btn",K),f("about-btn",J),f("fullscreen-btn",A),f("music-btn",R),f("close-grid-btn",G),f("close-help-btn",G),f("close-meta-btn",G),f("close-admin-btn",()=>h("admin-modal").style.display="none"),f("close-detail-btn",()=>{S(1)}),f("btn-view-music",()=>{u=!0,m=!0,(_(),G())}),f("btn-view-silent",()=>{u=!1,O(),G()}),f("nav-instruction-btn",()=>{G(),K()});function X(){const e=[h("help-list-nav"),h("help-list-info")];e.forEach(e=>{e&&e.addEventListener("click",e=>{const t=e.target.closest("li");if(!t)return;const n=t.getAttribute("data-action");"category-nav"!==n?G():G();switch(n){case"next":T(1);break;case"prev":T(-1);break;case"fullscreen":A();break;case"slideshow":C();break;case"stop":x();break;case"info":M();break;case"music":R();break;case"help":K();break;case"info-modal":J();break;case"grid":Y();break;case"shuffle":a.sort(()=>Math.random()-.5),l=0,T(0),v("Shuffled");break;case"category-nav":v("Use PageUp / PageDown keys");break;case"reset":z();break;case"next-track":U();break;case"end":openEndScreen();break;case"silent":q();break}})})}(function(){X()})(),document.addEventListener("keydown",e=>{const t=h("grid-modal"),n=t&&"flex"===t.style.display,o=h("photo-details-modal"),s=o&&"flex"===o.style.display,c=h("meta-modal"),d=c&&"flex"===c.style.display,u=h("help-modal"),m=u&&"flex"===u.style.display,g=h("end-screen-modal"),y=g&&"flex"===g.style.display,E=document.querySelector('.overlay-modal[style*="flex"]');if(("Escape"===e.key||"0"===e.key)&&p)return e.preventDefault(),void x();if(d){if(["ArrowRight","ArrowLeft"," ","Enter"].includes(e.key))e.preventDefault(),u=!1,O(),G();else{if("Escape"===e.key)return void G();return}}if(m){if(["ArrowRight","ArrowLeft"," ","Enter","Home","PageUp","PageDown"].includes(e.key))G();else{if("Escape"===e.key)return void G();return}}if(y){if(["ArrowUp","ArrowDown","Enter"].includes(e.key))return e.preventDefault(),void("function"==typeof window.lpEndNav&&window.lpEndNav(e.key));if(["ArrowRight","ArrowLeft"," ","Home","PageUp","PageDown","Escape"].includes(e.key))return void G();return}if(n){if("Escape"===e.key||"p"===e.key.toLowerCase())return void G();if(["ArrowRight","ArrowLeft"," ","ArrowUp","ArrowDown","f","h","m","i"].includes(e.key)||["ArrowRight","ArrowLeft"," ","ArrowUp","ArrowDown","f","h","m","i"].includes(e.key.toLowerCase()))G();else return}if(s){if("ArrowUp"===e.key)return e.preventDefault(),void P();if("ArrowDown"===e.key)return e.preventDefault(),void B();if("Escape"===e.key)return void S(1)}else if(E&&!d&&!m&&!y){if("Escape"===e.key)return void G();return}if(e.shiftKey&&"a"===e.key.toLowerCase())return void Q();switch(e.key){case"ArrowRight":case" ":T(1);break;case"ArrowLeft":T(-1);break;case"ArrowUp":e.preventDefault(),P();break;case"ArrowDown":e.preventDefault(),B();break;case"f":case"F":A();break;case"h":case"H":K();break;case"m":case"M":R();break;case"i":case"I":J();break;case"p":case"P":Y();break;case"0":p&&C();break;case"PageUp":e.preventDefault(),j(-1);break;case"PageDown":e.preventDefault(),j(1);break;case"Home":e.preventDefault(),z();break;case"Insert":e.preventDefault(),U();break;case"End":e.preventDefault(),openEndScreen();break;case"s":case"S":q();break;case"r":case"R":a.sort(()=>Math.random()-.5),l=0,T(0),v("Shuffled");break}e.key>="1"&&e.key<="9"&&(p&&clearInterval(p),speed=(parseInt(e.key)+5)*1e3,p=setInterval(()=>T(1),speed),v(`Slideshow: ${speed/1e3}s`))}),document.addEventListener("fullscreenchange",()=>{document.fullscreenElement?document.body.classList.add("is-fullscreen"):document.body.classList.remove("is-fullscreen")}),V()});
