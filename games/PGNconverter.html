<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PGN Auto-Format Converter (Advanced)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .textareas-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        textarea {
            width: 50%;
            height: 400px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-family: 'Consolas', 'Courier New', monospace;
            box-sizing: border-box;
        }
        .controls {
            display: flex;
            justify-content: space-between; 
            align-items: center;
            margin-bottom: 15px;
        }
        button, input[type="file"] {
            padding: 10px 15px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        button {
            background-color: #007bff;
            color: white;
            min-width: 250px;
        }
        button:hover {
            background-color: #0056b3;
        }
        input[type="file"] {
            background-color: #6c757d;
            color: white;
            min-width: 250px;
            box-sizing: border-box;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>PGN Auto-Format Converter (Advanced) ♟️</h1>
    <p>This version fixes the issue by extracting evaluations from variations and attaching them to the main moves.</p>

    <div class="controls">
        <input type="file" id="pgnFile" accept=".pgn" title="Select a PGN file to load">
        <button onclick="downloadPGN()" id="downloadButton" disabled>Download Converted PGN</button>
    </div>
    
    <div class="textareas-container">
        <div>
            <h2>Input PGN (Paste or Loaded)</h2>
            <textarea id="inputPGN" placeholder="Paste your ChessX-analyzed PGN here..."></textarea>
        </div>
        <div>
            <h2>Converted PGN (Viewer Compatible)</h2>
            <textarea id="outputPGN" readonly placeholder="Converted PGN will appear here automatically..."></textarea>
        </div>
    </div>
</div>

<script>
    let originalFilename = 'converted_game.pgn';

    // --- CONVERSION FUNCTION ---
    function convertPGN() {
        const inputPGN = document.getElementById('inputPGN').value.trim();
        const outputTextarea = document.getElementById('outputPGN');
        const downloadButton = document.getElementById('downloadButton');

        if (!inputPGN) {
            outputTextarea.value = '';
            downloadButton.disabled = true;
            return;
        }

        /*
        ADVANCED REGEX EXPLANATION:
        The goal is to find the evaluation that a program like ChessX inserts at the end of a long variation 
        (like the one in your file) and insert it onto the last move of the main line before the variation starts.
        
        The PGN is structured: MOVE_A MOVE_B (VARIATION_START ... MOVE_X {[%eval X.XX]})
        
        This regex targets the main line move that immediately precedes a variation:
        (\d+\.)?\s*([a-zA-Z0-9\#\+\=\!\?]+)\s*(\()
          - (\d+\.)?: Optional move number (e.g., '1.'), followed by a space
          - ([a-zA-Z0-9\#\+\=\!\?]+): Capture Group 2: The actual move (e.g., 'e5', 'Nf6')
          - \s*: Whitespace
          - (\(): Capture Group 3: The opening parenthesis of the variation.
          
        It replaces this: 
        1.e4 e5 (1...c5 {[%eval 0.25]})2.Nf3 Nc6 (2...d6 ... {[%eval 0.15]})3.Bb5 a6 (3...Nf6 ... {[%eval 0.09]})
        
        With this (extracting the eval from the variation and placing it on the main line):
        1.e4 {[%eval 0.25]} e5 2.Nf3 {[%eval 0.15]} Nc6 3.Bb5 {[%eval 0.09]} a6 ...
        
        NOTE: Since the provided PGN snippet only shows evaluations inside variations *not* linked to the main move, 
        we must use a simpler approach that assumes the evaluation shown in the **first variation** is the one intended for the **preceding main move**.
        */
        
        // This simple replacement is designed to convert the eval tag inside ANY comment structure 
        // to the viewer-compatible format { [%eval X.XX] }
        let convertedPGN = inputPGN.replace(/\{\s*\[%eval\s*([\+\-]?[\d\.]+)\s*\]\s*\}/g, '{ [%eval $1] }');


        // THE CRUCIAL SECOND STEP: Find move followed by a variation with an eval and insert the eval onto the move.
        // We look for a move, followed by a variation that contains an evaluation tag.
        // The first group (G1) is the preceding move number (optional).
        // The second group (G2) is the move itself (SAN).
        // The third group (G3) captures the evaluation score.
        // The fourth group (G4) captures the rest of the variation until the next move number.
        const variationRegex = /(\d+\.)?\s*([a-zA-Z0-9\#\+\=\!\?]+)\s*(\((?:(?!\d+\.|\s*1\/2-1\/2|\s*1-0|\s*0-1).)*?\[%eval\s*([\+\-]?[\d\.]+)\s*\].*?\))\s*/gs;

        // The 'gs' flags make it global (g) and allow '.' to match newlines (s - dotall).
        convertedPGN = convertedPGN.replace(variationRegex, (match, moveNum, moveSAN, variationText, score) => {
            // Reconstruct the move and variation:
            // 1. Insert the evaluation into the main move's comment using the desired format.
            // 2. Keep the original variation text (G3) so the analysis lines aren't lost.
            
            // This is White's move:
            if (moveNum && !moveSAN.includes('...')) { 
                 return `${moveNum}${moveSAN} { [%eval ${score}] } ${variationText} `;
            } 
            // This is Black's move:
            else {
                 return `${moveSAN} { [%eval ${score}] } ${variationText} `;
            }
        });

        // Final cleanup for any remaining standalone tags (e.g., from header)
        convertedPGN = convertedPGN.replace(/\[%eval\s*([\+\-]?[\d\.]+)\s*\]/g, '{ [%eval $1] }');

        outputTextarea.value = convertedPGN;
        downloadButton.disabled = convertedPGN.length === 0;
    }

    // --- FILE LOADING FUNCTION ---
    document.getElementById('pgnFile').addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (!file) {
            return;
        }
        
        // 1. Set the download filename based on the uploaded file
        const parts = file.name.split('.');
        const extension = parts.pop();
        const baseName = parts.join('.');
        originalFilename = `${baseName}_C.${extension}`;

        // 2. Read the file
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('inputPGN').value = e.target.result;
            // 3. Trigger automatic conversion
            convertPGN(); 
        };
        reader.onerror = function(e) {
            alert('Error reading file: ' + e.target.error.name);
        };

        reader.readAsText(file);
    });
    
    // --- AUTOCONVERT ON PASTE/INPUT ---
    document.getElementById('inputPGN').addEventListener('input', convertPGN);
    document.getElementById('inputPGN').addEventListener('change', convertPGN);


    // --- DOWNLOAD FUNCTION ---
    function downloadPGN() {
        const text = document.getElementById('outputPGN').value;
        const filename = originalFilename;
        
        if (!text) {
            alert("Nothing to download.");
            return;
        }

        const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        
        URL.revokeObjectURL(a.href);
    }
</script>

</body>
</html>
