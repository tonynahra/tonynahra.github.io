<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tutorial Player</title>
    <link rel="stylesheet" href="common/mainPage.css">
    <link rel="stylesheet" href="common/tutorialEngine.css">
    <style>
        /* Extra styles for the summary overlay */
        #summaryOverlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85);
            color: #fff;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            overflow-y: auto;
        }
        .summary-box {
            background: #2c3e50;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #66fcf1;
            max-width: 90%;
            width: 400px;
            text-align: left;
            font-family: 'IBM Plex Mono', monospace;
        }
        .summary-box h2 { margin-top: 0; color: #66fcf1; text-align: center; }
        .summary-list { list-style: none; padding: 0; }
        .summary-list li { 
            padding: 8px 0; 
            border-bottom: 1px solid #444; 
            display: flex; 
            justify-content: space-between;
        }
        .summary-total { 
            font-weight: bold; 
            margin-top: 15px; 
            padding-top: 10px; 
            border-top: 2px solid #66fcf1; 
        }
        .close-summary-btn {
            margin-top: 20px;
            width: 100%;
            padding: 10px;
            background: #66fcf1;
            color: #1f2833;
            border: none;
            font-weight: bold;
            cursor: pointer;
        }
    </style>
</head>
<!-- Add tabindex to body to ensure it can catch keys immediately -->
<body class="tutorial-body" tabindex="0">

    <div id="tutorialContainer">
        <div id="loadingState" class="content-loader">
            <div class="spinner"></div>
            <p>Loading...</p>
        </div>

        <div id="tutorialSection" style="display: none;">
            
            <!-- Slide Image Area -->
            <div class="slide-container">
                <!-- Using width/height 100% in CSS to force full usage -->
                <img id="Main" src="" onclick="PageClick(event)" class="tutorial-slide" alt="Slide">
            </div>

            <!-- Navigation Bar -->
            <div class="nav-bar">
                <div id="Title" class="tutorial-title"></div>
                
                <div class="controls-group">
                    <button onclick="Credits()" class="engine-btn secondary">Credits</button> 
                    <button onclick="ShowSummary()" class="engine-btn secondary">Summary</button>
                </div>

                <div class="controls-group playback">
                    <button onclick="movePage(-1)" id="btnPrevious" class="engine-btn primary" title="Left Arrow">&larr; Prev</button>  
                    <span id="pageNo" class="page-counter">0 / 0</span>  
                    <button onclick="movePage(1)" id="btnNext" class="engine-btn primary" title="Right Arrow / Space">Next &rarr;</button>
                </div>
            </div>
            
            <audio id="Audio" src="" autoplay style="display: none;"></audio>
        </div>
        
        <div id="summaryOverlay">
            <div class="summary-box">
                <h2>Content Summary</h2>
                <ul id="summaryList" class="summary-list"></ul>
                <div id="summaryTotal" class="summary-total"></div>
                <button class="close-summary-btn" onclick="HideSummary()">Close</button>
            </div>
        </div>

        <div id="errorState" class="error-message" style="display: none;"></div>
    </div>

<script>
    var ServerPath = ""; 
    var TutorialManifest = []; // Changed to Array for JSON support
    var FeedbackNumber = 0;
    var totPages = 0;
    var totSections = 0;
    var currentPagePointer = 0;
    var QcurrentPagePointer = 0;
    var PageType = "";
    var doc;
    var TutorialLanguage = "English";
    var isJsonMode = false; // Flag for JSON album mode
    
    const CORS_PROXY = "https://corsproxy.io/?";

    var AudioObj, bntNext, bntPrevious, PageObject;
    var x = new XMLHttpRequest();

    window.onload = function() {
        document.body.focus();

        const urlParams = new URLSearchParams(window.location.search);
        const manifestUrl = urlParams.get('manifest');
        const theme = urlParams.get('theme');
        
        if(theme) document.body.classList.add(theme);

        if(!manifestUrl) {
            showError("No manifest URL specified.");
            return;
        }

        // Check file extension
        if (manifestUrl.toLowerCase().endsWith('.json')) {
            isJsonMode = true;
            fetchJsonManifest(manifestUrl);
        } else {
            // XML Mode (Original Tutorial)
            const lastSlashIndex = manifestUrl.lastIndexOf('/');
            ServerPath = manifestUrl.substring(0, lastSlashIndex + 1); 
            fetchXmlManifest(manifestUrl);
        }
    };

    // --- XML HANDLING ---
    function fetchXmlManifest(url) {
        const proxyUrl = CORS_PROXY + encodeURIComponent(url);
        x.open("GET", proxyUrl, true);
        x.onreadystatechange = function () {
            if (x.readyState == 4) {
                if(x.status == 200) {
                    try {
                        const parser = new DOMParser();
                        doc = parser.parseFromString(x.responseText, "text/xml");
                        if(!doc || doc.getElementsByTagName("parsererror").length > 0) {
                             showError("Error parsing XML manifest.");
                             return;
                        }
                        // Convert XML NodeList to Array for consistent handling
                        const nodes = doc.getElementsByTagName("s");
                        TutorialManifest = Array.from(nodes); 
                        initPlayer();
                    } catch (e) {
                        showError("Error processing manifest: " + e.message);
                    }
                } else {
                    showError("Failed to load manifest: " + x.status);
                }
            }
        };
        x.send(null);
    }

    // --- JSON HANDLING (NEW) ---
    function fetchJsonManifest(url) {
        // Fetch JSON directly (assuming jquery or fetch is available, or use XHR)
        // Using standard XHR for consistency
        const proxyUrl = CORS_PROXY + encodeURIComponent(url);
        x.open("GET", proxyUrl, true);
        x.onreadystatechange = function () {
            if (x.readyState == 4) {
                if(x.status == 200) {
                    try {
                        const data = JSON.parse(x.responseText);
                        buildManifestFromJson(data);
                        initPlayer();
                    } catch (e) {
                        showError("Error parsing JSON album: " + e.message);
                    }
                } else {
                    showError("Failed to load album: " + x.status);
                }
            }
        };
        x.send(null);
    }

    function buildManifestFromJson(data) {
        // Convert flat photo list into structured manifest with sections
        const title = data.albumTitle || "Photo Album";
        TutorialLanguage = "Visual"; // No audio
        
        // Update title immediately
        document.getElementById("Title").innerHTML = `<strong>${title}</strong>`;
        
        TutorialManifest = [];
        let currentCategory = "";

        // 1. Add Intro Slide (Optional, or just start)
        
        data.photos.forEach(photo => {
            // If category changes, add a Section node
            if (photo.category !== currentCategory) {
                currentCategory = photo.category;
                TutorialManifest.push({
                    type: "s", // Section
                    title: currentCategory,
                    isJson: true
                });
            }

            // Add Photo node
            TutorialManifest.push({
                type: "o", // Object/Slide
                url: photo.url,
                thumb: photo.thumbnailUrl,
                title: photo.title,
                desc: photo.description,
                isJson: true
            });
        });

        // Add End node
        TutorialManifest.push({ type: "end", isJson: true });
    }

    // --- PLAYER LOGIC ---

    // --- KEYBOARD NAVIGATION ---
    document.addEventListener('keydown', function(e) {
        if (document.getElementById("errorState").style.display === "block") return;

        switch(e.key) {
            case "ArrowLeft": movePage(-1); break;
            case "ArrowRight":
            case " ": // Spacebar
                e.preventDefault(); 
                movePage(1);
                break;
            case "PageDown":
                e.preventDefault();
                navToSection(1); 
                break;
            case "PageUp":
                e.preventDefault();
                navToSection(-1);
                break;
        }
    });

    function navToSection(direction) {
        let foundIndex = -1;
        if (direction === 1) {
            for (let i = currentPagePointer + 1; i < totPages; i++) {
                if (isJsonMode) {
                    if (TutorialManifest[i].type === "s") { foundIndex = i; break; }
                } else {
                    if (TutorialManifest[i].getAttribute("p") === "s") { foundIndex = i; break; }
                }
            }
        } else {
            for (let i = currentPagePointer - 1; i >= 0; i--) {
                if (isJsonMode) {
                    if (TutorialManifest[i].type === "s") { foundIndex = i; break; }
                } else {
                    if (TutorialManifest[i].getAttribute("p") === "s") { foundIndex = i; break; }
                }
            }
        }
        if (foundIndex !== -1) {
            currentPagePointer = foundIndex;
            movePage(0); 
        }
    }

    function initPlayer() {
        document.getElementById("loadingState").style.display = "none";
        document.getElementById("tutorialSection").style.display = "flex";
        
        setTutorialParameters();
        movePage(0);
    }

    function setTutorialParameters() {
        totPages = TutorialManifest.length;
        
        if (isJsonMode) {
            // JSON Mode Parameters
            totSections = 0;
            for (let i = 0; i < totPages; i++) {
                if (TutorialManifest[i].type === "s") totSections++;
            }
            // Title already set in build function
        } else {
            // XML Mode Parameters
            for (i = 0; i < totPages; i++) if (TutorialManifest[i].getAttribute("p") == "s") totSections++;
            
            const Title = doc.getElementsByTagName("Title")[0].textContent;
            TutorialLanguage = doc.getElementsByTagName("Language")[0].textContent;
            document.getElementById("Title").innerHTML = `<strong>${Title}</strong> <span style="opacity:0.7; font-size:0.8em">(${TutorialLanguage})</span>`;
        }
        
        AudioObj = document.getElementById("Audio");
        bntNext = document.getElementById("btnNext");
        bntPrevious = document.getElementById("btnPrevious");
        PageObject = document.getElementById("Main");
        currentPagePointer = 0;
    }

    function movePage(Step) {
        if (PageType != "" || Step == 1) currentPagePointer = currentPagePointer + Step; else currentPagePointer = QcurrentPagePointer;
        if (currentPagePointer > 0) bntPrevious.disabled = false; else bntPrevious.disabled = true;
        QcurrentPagePointer = currentPagePointer;
        
        if (currentPagePointer < totPages) {
            
            if (isJsonMode) {
                // --- JSON MODE RENDER ---
                const item = TutorialManifest[currentPagePointer];
                PageType = item.type;
                
                if (PageType === "end") {
                     bntNext.disabled = true;
                     document.getElementById("Main").src = "https://placehold.co/800x600/000000/ffffff?text=End+of+Album"; // Fallback
                     return;
                }
                
                if (PageType === "s") {
                    // Section Slide - Show Title Overlay? 
                    // For now, we skip to next or show a placeholder
                    // Let's show a section title card
                    const canvas = document.createElement('canvas');
                    canvas.width = 800; canvas.height = 600;
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = "#1f2833"; ctx.fillRect(0,0,800,600);
                    ctx.fillStyle = "#66fcf1"; ctx.font = "bold 60px Arial"; ctx.textAlign = "center";
                    ctx.fillText(item.title, 400, 300);
                    document.getElementById("Main").src = canvas.toDataURL();
                } else {
                    // Photo Slide
                     document.getElementById("Main").src = item.url;
                }
                
                bntNext.disabled = (currentPagePointer >= totPages - 1);

            } else {
                // --- XML MODE RENDER (Original) ---
                // Check bounds
                if (currentPagePointer >= totPages) { return; } // Safety
                
                // Special check for end
                if (currentPagePointer === totPages - 1 && TutorialManifest[currentPagePointer].tagName !== 's') {
                     // It's the end
                } else if (TutorialManifest[currentPagePointer].getAttribute("f").includes("end")) {
                     // End detected in manifest
                }

                PageType = TutorialManifest[currentPagePointer].getAttribute("p");

                // Handle End Slide logic which might be inside the loop for XML
                // The XML structure usually has a specific node for end, or we run off the end.
                // Let's follow strict index.
                
                 let fileExt = ".png";
                if (TutorialManifest[currentPagePointer].getAttribute("a") == "1") fileExt = ".gif";
                if (PageType == "s") fileExt = "_S.png";

                const filename = TutorialManifest[currentPagePointer].getAttribute("f");
                
                // XML End logic check
                if (filename.includes("end")) {
                     // It is an end slide
                     bntNext.disabled = true;
                     // Construct relative path for end
                     // Note: logic from before
                     const langExt = (TutorialLanguage === "Spanish") ? "_s" : "";
                     document.getElementById("Main").src = ServerPath + "../../common/end" + langExt + ".gif";
                     AudioObj.src = ServerPath + "../../common/end" + langExt + ".mp3";
                } else {
                    document.getElementById("Main").src = ServerPath + "slides/m_" + filename + fileExt;
                    AudioObj.src = ServerPath + "sound/m_s" + filename + ".mp3";
                    
                    // Play Audio
                    var playPromise = AudioObj.play();
                    if (playPromise !== undefined) {
                        playPromise.catch(error => { console.log("Autoplay prevented."); });
                    }
                }

                if (PageType == "q") {
                    bntNext.disabled = true;
                    FeedbackNumber = TutorialManifest[currentPagePointer].getElementsByTagName("f").length;
                } else {
                    glossaryNumber = TutorialManifest[currentPagePointer].getElementsByTagName("g").length;
                    bntNext.disabled = false;
                    FeedbackNumber = 0;
                }
            }
        } 
        
        document.getElementById("pageNo").textContent = (currentPagePointer + 1) + " / " + totPages;
    }

    function PageClick(e) {
        if (isJsonMode) {
            movePage(1); // Just advance
            return;
        }
        
        var rect = e.target.getBoundingClientRect();
        var x = e.clientX - rect.left;
        var y = e.clientY - rect.top;
        const pcntX = parseInt(100 * x / rect.width);

        if (PageType == "s") {
            if ( 20 < pcntX && pcntX < 80 ) JumpToSection(y, rect.height);
        } else if (PageType == "c") {
            movePage(0);
        } else if (PageType == "g" || PageType == "c") {
            movePage(1);
        } else {
            let BTN = 0;
            const glossaryNumber = TutorialManifest[currentPagePointer].getElementsByTagName("g").length;

            if (PageType == "q") {
                for (let j = 1; j <= FeedbackNumber; j++) {
                    const ButtonLimits = TutorialManifest[currentPagePointer].getAttribute("b" + j).split(",");
                    if (parseInt(ButtonLimits[0]) < pcntX && pcntX < parseInt(ButtonLimits[2]) && parseInt(ButtonLimits[1]) < pcntY && pcntY < parseInt(ButtonLimits[3])) BTN = j;
                }
            }
            for (let j = 1; j <= glossaryNumber; j++) {
                const ButtonLimits = TutorialManifest[currentPagePointer].getAttribute("b" + j).split(",");
                if (parseInt(ButtonLimits[0]) < pcntX && pcntX < parseInt(ButtonLimits[2]) && parseInt(ButtonLimits[1]) < pcntY && pcntY < parseInt(ButtonLimits[3])) BTN = j;
            }

            if (BTN > 0) {
                let fName, wName;
                if (PageType == "q") {
                    fName = TutorialManifest[currentPagePointer].getElementsByTagName("f")[BTN - 1].getAttribute("f");
                    document.getElementById("Main").src = ServerPath + "slides/m_" + fName + ".png";
                    AudioObj.src = ServerPath + "sound/m_s" + fName + ".mp3";
                } else {
                    wName = TutorialManifest[currentPagePointer].getElementsByTagName("g")[BTN - 1].getAttribute("w");
                    document.getElementById("Main").src = ServerPath + "slides/m_" + wName + ".png";
                    AudioObj.src = ServerPath + "sound/" + wName + "_s_m.mp3";
                }
                AudioObj.play();
                QcurrentPagePointer = currentPagePointer;
                
                const correctAnswer = parseInt(TutorialManifest[currentPagePointer].getAttribute("ca"));
                if (PageType != "q" || BTN != correctAnswer) currentPagePointer--;
                
                if (PageType == "o") PageType = "g"; else PageType = "";
                bntNext.disabled = false;
            }
        }
    }

    function ShowSummary() {
        const summaryList = document.getElementById('summaryList');
        const summaryTotal = document.getElementById('summaryTotal');
        summaryList.innerHTML = '';
        
        let sectionCount = 0;
        let questionCount = 0;
        let totalPages = TutorialManifest.length;
        let currentSectionPages = 0;
        let sectionName = "Intro";

        for (let i = 0; i < TutorialManifest.length; i++) {
            let type;
            if (isJsonMode) {
                type = TutorialManifest[i].type;
                if (type === "s") {
                    if (i > 0) addSummaryItem(sectionName, currentSectionPages);
                    sectionName = TutorialManifest[i].title;
                    sectionCount++;
                    currentSectionPages = 0;
                }
            } else {
                type = TutorialManifest[i].getAttribute("p");
                if (type === "s") {
                    if (i > 0) addSummaryItem(sectionName, currentSectionPages);
                    sectionName = TutorialManifest[i].getAttribute("s") || `Section ${sectionCount + 1}`;
                    sectionCount++;
                    currentSectionPages = 0;
                }
            }
            
            if (type === "q") questionCount++;
            currentSectionPages++;
        }
        addSummaryItem(sectionName, currentSectionPages);

        summaryTotal.innerHTML = `
            <div>Total Sections: ${sectionCount}</div>
            <div>Total Pages: ${totalPages}</div>
            ${isJsonMode ? '' : `<div>Total Questions: ${questionCount}</div>`}
        `;
        document.getElementById('summaryOverlay').style.display = 'flex';
    }

    function addSummaryItem(name, pageCount) {
        const li = document.createElement('li');
        li.innerHTML = `<span>${name}</span> <span>${pageCount} slides</span>`;
        document.getElementById('summaryList').appendChild(li);
    }

    function HideSummary() {
        document.getElementById('summaryOverlay').style.display = 'none';
    }
    
    function Credits() {
        if (isJsonMode) {
            alert("Photo Album generated dynamically.");
        } else {
            document.getElementById("Main").src = ServerPath + "slides/credits.png";
            PageType = "c";
        }
    }
    
    function Manifest() {
        const urlParams = new URLSearchParams(window.location.search);
        window.open(urlParams.get('manifest'), "_blank");
    }
</script>
</body>
</html>
