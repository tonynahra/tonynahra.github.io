<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tutorial Player</title>
    <style>
        :root { --bg-color: #ffffff; --text-main: #2c3e50; --accent: #2980b9; --accent-hover: #3498db; --success: #27ae60; --error: #c0392b; --font-stack: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
        body { margin: 0; padding: 0; font-family: var(--font-stack); background-color: var(--bg-color); color: var(--text-main); height: 100vh; width: 100vw; overflow: hidden; display: flex; flex-direction: column; }
        
        /* --- CONTENT --- */
        #slide-container { flex: 1; overflow-y: auto; padding: 40px 30px 100px 30px; display: flex; justify-content: center; align-items: flex-start; }
        .slide-content { max-width: 800px; width: 100%; background: #fff; opacity: 0; transform: translateY(10px); transition: opacity 0.4s ease, transform 0.4s ease; }
        .slide-content.active { opacity: 1; transform: translateY(0); }
        
        /* --- IMAGE MODE --- */
        .image-slide-container { display: flex; justify-content: center; align-items: center; height: 100%; width: 100%; }
        .tutorial-image { max-width: 100%; max-height: 80vh; object-fit: contain; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }

        /* --- TEXT MODE --- */
        h1 { color: var(--accent); font-size: 2.2rem; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        h2 { color: var(--text-main); margin-top: 30px; font-size: 1.5rem; }
        p { font-size: 1.1rem; line-height: 1.6; color: #444; margin-bottom: 15px; }
        ul, ol { font-size: 1.1rem; line-height: 1.6; color: #444; margin-bottom: 20px; padding-left: 25px; }
        
        /* --- QUIZ --- */
        .quiz-container { margin-top: 30px; background: #f8f9fa; padding: 25px; border-radius: 10px; border: 1px solid #e9ecef; }
        .quiz-question { font-size: 1.25rem; font-weight: 600; margin-bottom: 20px; color: #2c3e50; }
        .quiz-option { background: #ffffff; border: 2px solid #e0e0e0; padding: 15px 20px; margin-bottom: 12px; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; font-size: 1.05rem; display: flex; justify-content: space-between; align-items: center; }
        .quiz-option:hover:not(.disabled) { border-color: var(--accent); background: #f0f8ff; }
        .quiz-option.selected { border-color: var(--accent); background: #e1f0fa; font-weight: 600; }
        .quiz-option.correct { border-color: var(--success); background: #d4edda; color: #155724; }
        .quiz-option.incorrect { border-color: var(--error); background: #f8d7da; color: #721c24; }
        .quiz-option.disabled { cursor: default; opacity: 0.7; pointer-events: none; }
        .quiz-option::after { content: ''; font-weight: bold; font-size: 1.2rem; }
        .quiz-option.correct::after { content: '‚úì'; color: var(--success); }
        .quiz-option.incorrect::after { content: '‚úï'; color: var(--error); }
        
        .feedback-box { margin-top: 20px; padding: 15px; border-radius: 8px; display: none; font-size: 1rem; line-height: 1.5; }
        .feedback-box.visible { display: block; animation: slideDown 0.3s ease; }
        .feedback-success { background: #d4edda; border-left: 5px solid var(--success); color: #155724; }
        .feedback-error { background: #fff3cd; border-left: 5px solid #f39c12; color: #856404; }
        .btn-submit { margin-top: 20px; padding: 12px 30px; background: var(--accent); color: white; border: none; border-radius: 50px; font-size: 1rem; font-weight: bold; cursor: pointer; transition: background 0.3s; display: inline-block; }
        .btn-submit:hover:not(:disabled) { background: var(--accent-hover); }
        .btn-submit:disabled { background: #bdc3c7; cursor: not-allowed; }

        /* --- NAV BAR --- */
        .nav-bar { width: 100%; background: #ffffff; border-top: 1px solid #eee; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); box-sizing: border-box; z-index: 1000; }
        .nav-btn { background: transparent; border: 2px solid var(--accent); color: var(--accent); padding: 8px 20px; border-radius: 25px; font-weight: 600; cursor: pointer; font-size: 0.95rem; transition: all 0.2s; }
        .nav-btn:hover:not(:disabled) { background: var(--accent); color: white; }
        .nav-btn:disabled { border-color: #e0e0e0; color: #ccc; cursor: default; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="slide-container"><div class="slide-content" id="content-area"><div style="text-align:center; padding-top: 50px; color:#999;"><p>Loading content...</p></div></div></div>
    <div class="nav-bar"><button class="nav-btn" id="btn-prev" onclick="navigate(-1)">&#8592; Back</button><span class="progress-indicator" id="progress-text">Loading...</span><button class="nav-btn" id="btn-next" onclick="navigate(1)">Next &#8594;</button></div>

<script>
    let slides = []; let currentIndex = 0; let quizState = {}; let isImageMode = false;

    document.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const manifestUrl = urlParams.get('manifest');

        if (!manifestUrl) { showError("No tutorial manifest provided."); return; }

        if (manifestUrl.includes('.xml')) {
            loadXmlManifest(manifestUrl);
        } else {
            loadJsonManifest(manifestUrl);
        }

        document.addEventListener('keydown', (e) => {
            if(e.key === "ArrowRight") navigate(1);
            if(e.key === "ArrowLeft") navigate(-1);
            try { if(window.parent && window.parent.handleModalKeys) { window.parent.handleModalKeys({ key: e.key }); } } catch(err) { }
        });
    });

    function loadJsonManifest(url) {
        fetch(url).then(res => res.json()).then(data => {
            if (data.slides && Array.isArray(data.slides)) {
                slides = data.slides; isImageMode = false; loadSlide(0);
            } else { showError("Invalid JSON format."); }
        }).catch(err => showError("Failed to load JSON tutorial."));
    }

    function loadXmlManifest(url) {
        // STRATEGY: Try Direct Fetch first. If CORS fails, try Proxy.
        fetch(url)
            .then(res => {
                if (!res.ok) throw new Error('Direct fetch failed');
                return res.text();
            })
            .then(str => parseXml(str, url))
            .catch(err => {
                console.warn('Direct XML fetch failed, trying proxy...', err);
                // Fallback to Proxy
                const proxyUrl = `https://mediamaze.com/p/?url=${encodeURIComponent(url)}`;
                fetch(proxyUrl)
                    .then(res => {
                        if (!res.ok) throw new Error('Proxy fetch failed');
                        return res.text();
                    })
                    .then(str => parseXml(str, url))
                    .catch(finalErr => showError("Failed to load XML tutorial (CORS/Proxy Error)."));
            });
    }

    function parseXml(xmlStr, manifestUrl) {
        try {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlStr, "text/xml");
            const steps = xmlDoc.getElementsByTagName("step");
            
            slides = [];
            
            // Base URL logic for relative image paths
            // If manifest is https://site.com/folder/A2.xml, base is https://site.com/folder/
            const basePath = manifestUrl.substring(0, manifestUrl.lastIndexOf('/') + 1);

            for(let i=0; i<steps.length; i++) {
                // Try to find <image> tag
                let imgNode = steps[i].getElementsByTagName("image")[0];
                
                // If not found, some X-Plain XMLs use <img src="..."> in content
                if (!imgNode) {
                    const content = steps[i].textContent;
                    // Simple check if content implies an image path
                    if(content && content.trim().length > 0 && !content.includes('<')) {
                         // Sometimes the step content IS the image filename
                         // Let's assume if no child tags, it might be an image
                    }
                }

                if(imgNode) {
                    let imgSrc = imgNode.textContent.trim();
                    if (imgSrc) {
                        // Resolve Relative URL
                        if (!imgSrc.startsWith('http') && !imgSrc.startsWith('//')) {
                            imgSrc = basePath + imgSrc;
                        }
                        slides.push({ type: 'image', src: imgSrc });
                    }
                } else {
                    // Fallback logic for X-Plain format: often "Slide1.jpg", "Slide2.jpg" inferred
                    // If XML structure is strictly <step><image>...</image></step>, above works.
                    // If structure differs, we might need to adapt.
                    
                    // Heuristic: Check if there is ANY text content that looks like a filename
                    const stepText = steps[i].textContent.trim();
                    if (stepText.match(/\.(jpg|jpeg|png|gif)$/i)) {
                         let imgSrc = stepText;
                         if (!imgSrc.startsWith('http')) imgSrc = basePath + imgSrc;
                         slides.push({ type: 'image', src: imgSrc });
                    }
                }
            }

            if(slides.length === 0) {
                showError("No slides found in XML.");
            } else {
                isImageMode = true;
                loadSlide(0);
            }
        } catch (e) {
            console.error(e);
            showError("Error parsing XML data.");
        }
    }

    function loadSlide(index) {
        if (index < 0 || index >= slides.length) return;
        const contentArea = document.getElementById('content-area');
        contentArea.classList.remove('active');
        
        setTimeout(() => {
            currentIndex = index;
            const slide = slides[index];
            
            if (isImageMode) {
                const html = `<div class="image-slide-container"><img src="${slide.src}" class="tutorial-image" alt="Slide ${index+1}" onerror="this.onerror=null;this.src='placeholder.png';this.parentElement.innerHTML='<p style=\\'color:red\\'>Image failed to load.</p>'"></div>`;
                document.getElementById('content-area').innerHTML = html;
            } else {
                if (slide.type === 'quiz') renderQuiz(slide, index);
                else renderText(slide);
            }
            updateNav();
            contentArea.classList.add('active');
            document.getElementById('slide-container').scrollTop = 0;
        }, 200);
    }

    function navigate(dir) {
        const nextIndex = currentIndex + dir;
        if (nextIndex >= 0 && nextIndex < slides.length) loadSlide(nextIndex);
    }

    function updateNav() {
        document.getElementById('btn-prev').disabled = (currentIndex === 0);
        document.getElementById('btn-next').disabled = (currentIndex === slides.length - 1);
        document.getElementById('progress-text').innerText = `Page ${currentIndex + 1} of ${slides.length}`;
    }

    function showError(msg) { document.getElementById('content-area').innerHTML = `<div style="color:#c0392b; text-align:center; padding:40px;"><h3>Error</h3><p>${msg}</p></div>`; }
    function renderText(slide) { document.getElementById('content-area').innerHTML = `<h1>${slide.title || 'Tutorial'}</h1><div class="body-content">${slide.body || ''}</div>`; }
    
    function renderQuiz(slide, index) {
        const state = quizState[index] || { selected: null, submitted: false };
        const options = slide.options || [];
        let optionsHtml = '';
        options.forEach((opt, i) => {
            let classes = 'quiz-option';
            if (state.selected === i) classes += ' selected';
            if (state.submitted) {
                classes += ' disabled';
                if (i === slide.correctIndex) classes += ' correct'; else if (i === state.selected) classes += ' incorrect';
            }
            optionsHtml += `<div class="${classes}" id="opt-${i}" onclick="selectOption(${i})">${opt}</div>`;
        });
        let feedbackHtml = '';
        if (state.submitted) {
            const isCorrect = (state.selected === slide.correctIndex);
            const fbClass = isCorrect ? 'feedback-success' : 'feedback-error';
            const link = slide.explanationUrl ? `<br><a href="${slide.explanationUrl}" target="_blank" class="feedback-link">Learn More &rarr;</a>` : '';
            feedbackHtml = `<div class="feedback-box visible ${fbClass}"><strong>${isCorrect ? 'Correct!' : 'Incorrect.'}</strong><br>${slide.feedback || ''} ${link}</div>`;
        }
        const btnState = state.submitted ? 'style="display:none"' : (state.selected === null ? 'disabled' : '');
        document.getElementById('content-area').innerHTML = `<h1>üìù Knowledge Check</h1><div class="quiz-container"><div class="quiz-question">${slide.question}</div><div id="options-list">${optionsHtml}</div><button class="btn-submit" id="btn-submit" onclick="submitQuiz()" ${btnState}>Submit Answer</button><div id="feedback-area">${feedbackHtml}</div></div>`;
    }

    window.selectOption = function(optionIndex) {
        if (quizState[currentIndex] && quizState[currentIndex].submitted) return;
        quizState[currentIndex] = { ...quizState[currentIndex], selected: optionIndex };
        const allOpts = document.querySelectorAll('.quiz-option');
        allOpts.forEach(el => el.classList.remove('selected'));
        document.getElementById(`opt-${optionIndex}`).classList.add('selected');
        document.getElementById('btn-submit').disabled = false;
    };

    window.submitQuiz = function() {
        const state = quizState[currentIndex];
        if (!state || state.selected === null) return;
        state.submitted = true; loadSlide(currentIndex);
    };
</script>
</body>
</html>
