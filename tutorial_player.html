<!-- 
  Refactored Tutorial Engine
  Loaded into the modal by cardLogic.js
-->
<div id="tutorialContainer">
    <div id="tutorialSection" style="display: none;">
        
        <!-- The main slide image -->
        <img id="Main" src="" onclick="PageClick(event)" class="tutorial-slide">
        
        <!-- Navigation Controls -->
        <div class="tutorial-nav">
            <div id="Title" class="tutorial-title">Loading...</div>
            
            <div class="tutorial-controls">
                <button onclick="Credits()" class="nav-btn secondary">Credits</button> 
                <button onclick="Manifest()" class="nav-btn secondary">Manifest</button>
                
                <div class="playback-controls">
                    <button onclick="movePage(-1)" id="btnPrevious" class="nav-btn primary">Previous</button>  
                    <span id="pageNo" class="page-number"></span>  
                    <button onclick="movePage(1)" id="btnNext" class="nav-btn primary">Next</button>
                </div>
            </div>
        </div>
        
        <!-- Audio Player (Hidden but active) -->
        <audio id="Audio" src="" autoplay style="width: 100%; margin-top: 10px;"></audio>
    </div>
    
    <div id="error-container" class="error-message" style="display: none;"></div>
</div>

<script>
    // --- Configuration ---
    var ServerPath = ""; // Will be calculated dynamically
    var TutorialPath = ""; 
    var TutorialLanguage = "";
    var TutorialManifest;
    var FeedbackNumber = 0;
    var totPages = 0;
    var totSections = 0;
    var currentPagePointer = 0;
    var QcurrentPagePointer = 0;
    var PageType = "";
    var doc;
    
    var AudioObj, bntNext, bntPrevious, PageObject;
    var x = new XMLHttpRequest();

    // --- Engine Initialization ---
    function startTutorial() {
        // Get the manifest filename from the URL query string passed by cardLogic.js
        const urlParams = new URLSearchParams(window.location.search);
        const manifestUrl = urlParams.get('manifest'); // e.g., "https://remote-server.com/path/to/mobile/A2.xml"
        
        if (!manifestUrl) {
            showError("No manifest URL specified.");
            return;
        }

        // --- NEW: Calculate ServerPath from the manifest URL ---
        // We assume the structure is .../modules/[TutorialPath]/mobile/A2.xml
        // So we need to strip "/mobile/A2.xml" to get the base path.
        
        // 1. Find the index of "/mobile/"
        const mobileIndex = manifestUrl.indexOf("/mobile/");
        
        if (mobileIndex !== -1) {
             // This gives us "https://remote-server.com/path/to/modules/diabetes/db180101"
             // We actually need the root "modules" path because the XML contains the folder "diabetes/db180101"
             // So we need to go up two levels from the folder structure.
             
             // Let's rely on the XML to give us the specific folder. 
             // We just need to find the root. 
             
             // NOTE: The original engine hardcoded "https://m.x-plain.com/modules/".
             // If your remote server has a different structure, we need to be careful.
             
             // Let's assume the XML is at [ROOT]/[FOLDER]/mobile/A2.xml
             // And the XML <folder> tag returns [FOLDER] (e.g. "diabetes/db180101")
             // So we need to extract [ROOT].
             
             // We will wait until we parse the XML to set the final ServerPath correctly.
        }

        x.open("GET", manifestUrl, true);
        x.onreadystatechange = function () {
            if (x.readyState == 4) {
                if (x.status == 200) {
                    doc = x.responseXML;
                    if (!doc || doc.getElementsByTagName("parsererror").length > 0) {
                        showError("Error parsing XML manifest.");
                        return;
                    }
                    
                    // --- NEW: Set ServerPath dynamically ---
                    // Get the folder defined in the XML (e.g. "diabetes/db180101")
                    const xmlFolder = doc.getElementsByTagName("folder")[0].textContent;
                    
                    // Now we look at the manifestURL (e.g. "https://.../modules/diabetes/db180101/mobile/A2.xml")
                    // We want to find the base that comes BEFORE the xmlFolder string.
                    
                    const splitIndex = manifestUrl.indexOf(xmlFolder);
                    if (splitIndex !== -1) {
                        ServerPath = manifestUrl.substring(0, splitIndex);
                    } else {
                        // Fallback if the folder structure doesn't match
                        // Assume the manifest is in /mobile/A2.xml and the root is 2 levels up
                         const mobileIdx = manifestUrl.indexOf("/mobile/");
                         if (mobileIdx !== -1) {
                             // This is tricky without knowing the exact folder structure.
                             // Let's try to infer it. If the XML says folder is "A/B", 
                             // and URL is ".../A/B/mobile/A2.xml", we want ".../"
                             
                             // Safe bet: The ServerPath is the part of the URL *before* the folder path.
                             // If we can't find the folder path in the URL, we might have a mismatch.
                             // For now, let's default to the directory of the manifest minus "/mobile/"
                             
                             // Let's try to construct the full path to the resources based on the manifest URL location
                             // manifestURL:  .../some/path/mobile/A2.xml
                             // resources:    .../some/path/mobile/slides/m_...
                             
                             // If we simply use the manifest URL's directory as the base for relative links,
                             // we don't need ServerPath logic at all!
                             
                             // Let's redefine how we build image URLs.
                        }
                    }

                    document.getElementById("tutorialSection").style.display = "block";
                    setTutorialParameters(manifestUrl);
                    movePage(0);
                } else {
                    showError(`Could not load manifest: ${manifestUrl} (Status: ${x.status})`);
                }
            }
        };
        x.send(null);
    }

    function showError(msg) {
        const errDiv = document.getElementById("error-container");
        errDiv.textContent = msg;
        errDiv.style.display = "block";
    }

    function setTutorialParameters(manifestUrl) {
        TutorialManifest = doc.getElementsByTagName("s");
        totPages = TutorialManifest.length;
        for (i = 0; i < totPages; i++) if (TutorialManifest[i].getAttribute("p") == "s") totSections++;
        
        Title = doc.getElementsByTagName("Title")[0].textContent;
        TutorialLanguage =  doc.getElementsByTagName("Language")[0].textContent;
        
        // --- NEW PATH LOGIC ---
        // We derive the base URL for resources (slides/sound) directly from the manifest URL.
        // If manifest is at: https://example.com/data/tutorials/diabetes/mobile/A2.xml
        // Images are at:     https://example.com/data/tutorials/diabetes/mobile/slides/
        // Sounds are at:     https://example.com/data/tutorials/diabetes/mobile/sound/
        
        // Remove "A2.xml" from the end
        const lastSlash = manifestUrl.lastIndexOf("/");
        const baseUrl = manifestUrl.substring(0, lastSlash + 1); // e.g. .../mobile/
        
        // Store this base for use in movePage
        window.tutorialBaseUrl = baseUrl;

        document.getElementById("Title").innerHTML = `<b>${Title}</b> <small>(${TutorialLanguage})</small>`;
        
        AudioObj = document.getElementById("Audio");
        bntNext = document.getElementById("btnNext");
        bntPrevious = document.getElementById("btnPrevious");
        PageObject = document.getElementById("Main");
        currentPagePointer = 0;
    }

    function movePage(Step) {
        if (PageType != "" || Step == 1) currentPagePointer = currentPagePointer + Step; else currentPagePointer = QcurrentPagePointer;
        
        if (currentPagePointer > 0) bntPrevious.disabled = false; else bntPrevious.disabled = true;
        
        QcurrentPagePointer = currentPagePointer;
        
        // Use the base URL we calculated
        const baseUrl = window.tutorialBaseUrl;
        
        if (currentPagePointer < totPages - 1) {
            PageType = TutorialManifest[currentPagePointer].getAttribute("p");

            fileExt = ".png"
            if (TutorialManifest[currentPagePointer].getAttribute("a") == "1") fileExt = ".gif"
            if (PageType == "s") fileExt = "_S.png"

            // Construct RELATIVE paths using the manifest's location
            Main = baseUrl + "slides/m_" + TutorialManifest[currentPagePointer].getAttribute("f") + fileExt;
            AudioObj.src = baseUrl + "sound/m_s" + TutorialManifest[currentPagePointer].getAttribute("f") + ".mp3";

            if (PageType == "q") {
                bntNext.disabled = true;
                FeedbackNumber = TutorialManifest[currentPagePointer].getElementsByTagName("f").length;
            } else {
                glossaryNumber = TutorialManifest[currentPagePointer].getElementsByTagName("g").length;
                bntNext.disabled = false;
                FeedbackNumber = 0;
            }
        } else {
            bntNext.disabled = true;
            if ( TutorialLanguage == "Spanish" ) LanguageExt = "_s"; else LanguageExt = "";
            
            // Note: "common/end" might need adjustment depending on where 'common' lives relative to the XML
            // If 'common' is a sibling of the tutorial folder (e.g. .../modules/common), we need to go up 2 levels.
            // For simplicity, let's assume standard structure: ../../common/
            
            Main = baseUrl + "../../common/end" + LanguageExt + ".gif";
            AudioObj.src = baseUrl + "../../common/end" + LanguageExt + ".mp3";
        }
        
        document.getElementById("Main").src = Main;
        AudioObj.play().catch(e => console.log("Autoplay prevented."));
        document.getElementById("pageNo").textContent = (currentPagePointer + 1) + " / " + totPages;
    }

    function PageClick(e) {
        var rect = e.target.getBoundingClientRect();
        var x = e.clientX - rect.left;
        var y = e.clientY - rect.top;

        pcntX = parseInt(100 * x / rect.width);
        pcntY = parseInt(100 * y / rect.height);

        if (PageType == "s") {
            if ( 20 < pcntX && pcntX < 80 ) JumpToSection(y, rect.height);
        } else if (PageType == "c") {
            movePage(0);
        } else if (PageType == "g" || PageType == "c") {
            movePage(1);
        } else {
            BTN = 0;
            const baseUrl = window.tutorialBaseUrl;
            
            if (PageType == "q") {
                for (j = 1; j <= FeedbackNumber; j++) {
                    ButtonLimits = TutorialManifest[currentPagePointer].getAttribute("b" + j).split(",");
                    if (parseInt(ButtonLimits[0]) < pcntX && pcntX < parseInt(ButtonLimits[2]) && parseInt(ButtonLimits[1]) < pcntY && pcntY < parseInt(ButtonLimits[3])) BTN = j;
                }
            }
            for (j = 1; j <= glossaryNumber; j++) {
                ButtonLimits = TutorialManifest[currentPagePointer].getAttribute("b" + j).split(",");
                if (parseInt(ButtonLimits[0]) < pcntX && pcntX < parseInt(ButtonLimits[2]) && parseInt(ButtonLimits[1]) < pcntY && pcntY < parseInt(ButtonLimits[3])) BTN = j;
            }
            if (BTN > 0) {
                if (PageType == "q") {
                    Main = baseUrl + "slides/m_" + TutorialManifest[currentPagePointer].getElementsByTagName("f")[BTN - 1].getAttribute("f") + ".png";
                    AudioObj.src = baseUrl + "sound/m_s" + TutorialManifest[currentPagePointer].getElementsByTagName("f")[BTN - 1].getAttribute("f") + ".mp3";
                } else {
                    Main = baseUrl + "slides/m_" + TutorialManifest[currentPagePointer].getElementsByTagName("g")[BTN - 1].getAttribute("w") + ".png";
                    AudioObj.src = baseUrl + "sound/" + TutorialManifest[currentPagePointer].getElementsByTagName("g")[BTN - 1].getAttribute("w") + "_s_m.mp3";
                }

                document.getElementById("Main").src = Main;
                AudioObj.play();
                QcurrentPagePointer = currentPagePointer;
                if (PageType != "q" || BTN != parseInt(TutorialManifest[currentPagePointer].getAttribute("ca"))) currentPagePointer--;
                if (PageType == "o") PageType = "g"; else PageType = "";
                bntNext.disabled = false;
            }

        }
    }

    function Credits() {
        const baseUrl = window.tutorialBaseUrl;
        Main = baseUrl + "slides/credits.png";
        document.getElementById("Main").src = Main;
        PageType = "c";
    }

    function JumpToSection(absY, currentHeight) {
        SEC = parseInt((((absY * 480) / currentHeight) - 75) * totSections / 380) + 1;
        var SecFind = 0;
        for (k = 0; k < totPages; k++) {
            if (TutorialManifest[k].getAttribute("p") == "s") SecFind++;
            if (SecFind == SEC) {
                currentPagePointer = k;
                movePage(0);
                break;
            }
        }
    }

    function Manifest() {
        // Open the manifest XML in a new window
        const urlParams = new URLSearchParams(window.location.search);
        const manifestFile = urlParams.get('manifest');
        window.open(manifestFile, "_blank");
    }

    // Initialize
    startTutorial();

</script>
