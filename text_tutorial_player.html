<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Tutorial</title>
    <style>
        /* --- CORE VARIABLES & RESET --- */
        :root {
            --bg-color: #f4f4f9;
            --card-bg: #ffffff;
            --text-main: #333;
            --text-light: #666;
            --accent: #2980b9;
            --accent-hover: #3498db;
            --success: #2ecc71;
            --error: #e74c3c;
            --font-main: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: var(--font-main);
            background-color: var(--bg-color);
            color: var(--text-main);
            overflow: hidden; /* layout handled by flex container */
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
        }

        /* --- MAIN SLIDE CONTAINER --- */
        #slide-container {
            flex: 1;
            overflow-y: auto; /* Allow vertical scroll for long text */
            padding: 40px 20px 80px 20px; /* Bottom padding for nav bar */
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .slide-content {
            background: var(--card-bg);
            max-width: 800px;
            width: 100%;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            animation: fadeIn 0.4s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- TYPOGRAPHY --- */
        h1 { color: var(--accent); margin-top: 0; font-size: 2rem; }
        h2 { color: #2c3e50; margin-top: 0; }
        p { line-height: 1.6; font-size: 1.1rem; color: #444; }
        ul, ol { line-height: 1.6; font-size: 1.1rem; color: #444; }
        li { margin-bottom: 10px; }
        code { background: #eee; padding: 2px 6px; border-radius: 4px; font-family: monospace; color: #c7254e; }
        pre { background: #2d2d2d; color: #f8f8f2; padding: 15px; border-radius: 8px; overflow-x: auto; }

        /* --- QUIZ STYLES --- */
        .quiz-options { list-style: none; padding: 0; margin-top: 20px; }
        .quiz-option {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1.05rem;
            position: relative;
        }
        .quiz-option:hover { border-color: var(--accent); background: #eaf6ff; }
        .quiz-option.selected { border-color: var(--accent); background: #d4eefc; font-weight: bold; }
        
        .quiz-option.correct { border-color: var(--success); background: #d4edda; color: #155724; }
        .quiz-option.incorrect { border-color: var(--error); background: #f8d7da; color: #721c24; }
        
        /* Icons for feedback */
        .quiz-option::after {
            content: ''; position: absolute; right: 15px; top: 50%; transform: translateY(-50%);
            font-weight: bold; font-size: 1.2rem;
        }
        .quiz-option.correct::after { content: '‚úì'; color: var(--success); }
        .quiz-option.incorrect::after { content: '‚úï'; color: var(--error); }

        .feedback-box {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            display: none; /* Hidden by default */
            font-size: 1rem;
            line-height: 1.5;
        }
        .feedback-box.show { display: block; animation: fadeIn 0.3s; }
        .feedback-success { background: #d4edda; border-left: 5px solid var(--success); color: #155724; }
        .feedback-error { background: #fff3cd; border-left: 5px solid #ffc107; color: #856404; }
        
        .feedback-link {
            display: inline-block;
            margin-top: 10px;
            color: var(--accent);
            text-decoration: none;
            font-weight: bold;
        }
        .feedback-link:hover { text-decoration: underline; }

        .btn-submit {
            display: inline-block;
            margin-top: 20px;
            padding: 10px 25px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.3s;
        }
        .btn-submit:hover { background: var(--accent-hover); }
        .btn-submit:disabled { background: #ccc; cursor: not-allowed; }

        /* --- NAVIGATION BAR (Bottom) --- */
        .nav-bar {
            position: relative; /* Default relative */
            width: 100%;
            background: #fff;
            border-top: 1px solid #ddd;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-sizing: border-box;
            z-index: 100;
            transition: opacity 0.3s;
        }

        .nav-btn {
            background: transparent;
            border: 2px solid var(--accent);
            color: var(--accent);
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        .nav-btn:hover { background: var(--accent); color: white; }
        .nav-btn:disabled { border-color: #ccc; color: #ccc; cursor: default; background: transparent; }
        
        .progress-text { font-weight: bold; color: #7f8c8d; font-size: 0.9rem; }

    </style>
</head>
<body>

    <!-- Content Area -->
    <div id="slide-container">
        <div class="slide-content" id="content-area">
            <!-- Content Injected Here -->
            <div style="text-align:center; margin-top:50px; color:#666;">Loading Tutorial...</div>
        </div>
    </div>

    <!-- Navigation Bar -->
    <div class="nav-bar">
        <button class="nav-btn" id="btn-prev" onclick="changeSlide(-1)">&#8592; Prev</button>
        <span class="progress-text" id="progress-display">Loading...</span>
        <button class="nav-btn" id="btn-next" onclick="changeSlide(1)">Next &#8594;</button>
    </div>

<script>
    // --- State ---
    let slides = [];
    let currentSlideIndex = 0;
    let quizState = {}; // Stores answers

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const manifestUrl = urlParams.get('manifest') || 'sample_tutorial.json'; // Default for testing

        fetch(manifestUrl)
            .then(response => response.json())
            .then(data => {
                slides = data.slides || [];
                if(slides.length > 0) {
                    loadSlide(0);
                } else {
                    document.getElementById('content-area').innerHTML = '<p>No slides found in manifest.</p>';
                }
            })
            .catch(err => {
                console.error("Error loading tutorial:", err);
                document.getElementById('content-area').innerHTML = '<p class="error">Failed to load tutorial data.</p>';
            });
            
        // Keyboard Support
        document.addEventListener('keydown', (e) => {
            // Forward event to parent for global shortcuts (like Fullscreen/Close)
            try { if(window.parent) window.parent.handleModalKeys({key: e.key}); } catch(err){}

            if(e.key === "ArrowRight") changeSlide(1);
            if(e.key === "ArrowLeft") changeSlide(-1);
        });
    });

    // --- Core Logic ---
    function loadSlide(index) {
        if (index < 0 || index >= slides.length) return;
        currentSlideIndex = index;
        
        const slide = slides[index];
        const container = document.getElementById('content-area');
        
        // 1. Render Content
        let html = '';
        
        if (slide.type === 'quiz') {
            html = renderQuiz(slide, index);
        } else {
            // Standard Text Slide
            html = `<h1>${slide.title}</h1><div class="body-text">${slide.body}</div>`;
        }
        
        container.innerHTML = html;
        container.scrollTop = 0; // Reset scroll

        // 2. Update Nav UI
        document.getElementById('progress-display').innerText = `Step ${index + 1} of ${slides.length}`;
        document.getElementById('btn-prev').disabled = (index === 0);
        document.getElementById('btn-next').disabled = (index === slides.length - 1);
        
        // 3. Restore Quiz State if exists
        if(slide.type === 'quiz' && quizState[index]) {
            const saved = quizState[index];
            checkAnswer(index, saved.selectedIndex, false); // Restore visual state without re-saving
        }
    }

    function changeSlide(direction) {
        const newIndex = currentSlideIndex + direction;
        if (newIndex >= 0 && newIndex < slides.length) {
            loadSlide(newIndex);
        }
    }

    // --- Quiz Logic ---
    function renderQuiz(slide, index) {
        let optionsHtml = '';
        slide.options.forEach((opt, i) => {
            optionsHtml += `<li class="quiz-option" id="opt-${i}" onclick="selectOption(${index}, ${i})">${opt}</li>`;
        });

        return `
            <h2>üìù Knowledge Check</h2>
            <p style="font-weight:500; font-size:1.2rem; margin-bottom:20px;">${slide.question}</p>
            <ul class="quiz-options" id="quiz-list-${index}">${optionsHtml}</ul>
            <div class="feedback-box" id="feedback-${index}"></div>
            <button class="btn-submit" id="submit-${index}" onclick="submitQuiz(${index})" disabled>Submit Answer</button>
        `;
    }

    // Helper to track temporary selection before submitting
    let tempSelection = null;

    window.selectOption = function(slideIndex, optionIndex) {
        // Prevent changing if already submitted
        if(quizState[slideIndex] && quizState[slideIndex].submitted) return;

        // UI Update
        const options = document.querySelectorAll(`#quiz-list-${slideIndex} .quiz-option`);
        options.forEach(el => el.classList.remove('selected'));
        document.getElementById(`opt-${optionIndex}`).classList.add('selected');
        
        // Enable Submit
        document.getElementById(`submit-${slideIndex}`).disabled = false;
        tempSelection = optionIndex;
    };

    window.submitQuiz = function(slideIndex) {
        checkAnswer(slideIndex, tempSelection, true);
    };

    function checkAnswer(slideIndex, selectedIndex, isNewSubmission) {
        const slide = slides[slideIndex];
        const isCorrect = (selectedIndex === slide.correctIndex);
        
        // 1. Lock UI
        const options = document.querySelectorAll(`#quiz-list-${slideIndex} .quiz-option`);
        const btn = document.getElementById(`submit-${slideIndex}`);
        if(btn) btn.style.display = 'none'; // Hide submit button after check

        // 2. Visuals
        options.forEach((el, i) => {
            el.classList.remove('selected'); // Remove blue selected state
            el.onclick = null; // Disable clicks
            if (i === slide.correctIndex) el.classList.add('correct');
            else if (i === selectedIndex) el.classList.add('incorrect');
        });

        // 3. Feedback
        const fbBox = document.getElementById(`feedback-${slideIndex}`);
        if(fbBox) {
            const fbClass = isCorrect ? 'feedback-success' : 'feedback-error';
            const fbTitle = isCorrect ? 'Correct!' : 'Incorrect.';
            const explanationUrl = slide.explanationUrl ? `<br><a href="${slide.explanationUrl}" target="_blank" class="feedback-link">Read Explanation &rarr;</a>` : '';
            
            fbBox.className = `feedback-box show ${fbClass}`;
            fbBox.innerHTML = `<strong>${fbTitle}</strong><br>${slide.feedback}${explanationUrl}`;
        }

        // 4. Save State
        if(isNewSubmission) {
            quizState[slideIndex] = { submitted: true, selectedIndex: selectedIndex };
        }
    }
</script>
</body>
</html>
