<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Pulse v4 | Dynamic Model Manager</title>
    <style>
        :root {
            --bg-body: #f0f2f5;
            --bg-card: #ffffff;
            --text-main: #1f2937;
            --text-sub: #6b7280;
            --primary: #3b82f6;
            --success: #10b981;
            --error: #ef4444;
            --border: #e5e7eb;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
        }

        /* HEADER */
        .header {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--bg-card); padding: 16px 24px; border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 24px;
        }
        .header h1 { margin: 0; font-size: 20px; font-weight: 700; }
        .header-controls { display: flex; gap: 10px; }

        /* BUTTONS */
        .btn {
            padding: 8px 16px; border-radius: 6px; border: 1px solid var(--border);
            background: white; cursor: pointer; font-weight: 500; font-size: 13px;
            transition: 0.2s; display: inline-flex; align-items: center; gap: 6px;
        }
        .btn:hover { background: #f9fafb; border-color: #d1d5db; }
        .btn-primary { background: var(--primary); color: white; border: none; }
        .btn-primary:hover { background: #2563eb; }
        .btn-icon { padding: 4px 8px; font-size: 14px; }

        /* TABLE */
        .card { background: var(--bg-card); border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { background: #f9fafb; padding: 12px 20px; text-align: left; color: var(--text-sub); font-weight: 600; text-transform: uppercase; font-size: 12px; }
        td { padding: 12px 20px; border-bottom: 1px solid var(--border); vertical-align: middle; }
        tr:last-child td { border-bottom: none; }

        /* INPUTS & SELECTS */
        .model-container { display: flex; gap: 6px; align-items: center; }
        .model-select { 
            flex: 1; padding: 8px; border: 1px solid var(--border); 
            border-radius: 6px; font-size: 13px; max-width: 220px; 
        }

        /* STATUS BADGES */
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; display: inline-block; min-width: 60px; text-align: center; }
        .badge-idle { background: #f3f4f6; color: var(--text-sub); }
        .badge-ok { background: #d1fae5; color: #065f46; }
        .badge-err { background: #fee2e2; color: #991b1b; }
        .badge-load { background: #e0f2fe; color: #075985; animation: pulse 1s infinite; }
        @keyframes pulse { 50% { opacity: 0.5; } }

        /* MODAL */
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 100; backdrop-filter: blur(2px); }
        .modal { background: white; width: 500px; max-width: 90%; padding: 24px; border-radius: 12px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        .key-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
        .key-row input { width: 60%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; font-family: monospace; }
    </style>
</head>
<body>

<div class="header">
    <div style="display:flex; align-items:center; gap:12px;">
        <h1>AI Pulse v4</h1>
        <span style="font-size:12px; background:#e5e7eb; padding:2px 8px; border-radius:4px;">Dynamic Aliases</span>
    </div>
    <div class="header-controls">
        <input type="file" id="fileInput" accept=".json" style="display:none" onchange="handleImport(this)">
        <button class="btn" onclick="document.getElementById('fileInput').click()">ðŸ“‚ Import JSON</button>
        <button class="btn" onclick="openKeyModal()">ðŸ”‘ Keys</button>
        <button class="btn btn-primary" onclick="runGlobalTest()">âš¡ Run System Check</button>
    </div>
</div>

<div class="card">
    <table id="mainTable">
        <thead>
            <tr>
                <th width="20%">Provider</th>
                <th width="35%">Model Pointer (Latest Alias)</th>
                <th width="15%">Status</th>
                <th width="10%">Latency</th>
                <th width="20%">Integration</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>
</div>

<div id="keyModal" class="modal-overlay">
    <div class="modal">
        <h2 style="margin-top:0">API Keys & Config</h2>
        <div id="keyInputs"></div>
        <div style="margin-top:20px; display:flex; justify-content:flex-end; gap:8px;">
            <button class="btn" onclick="exportConfig()">ðŸ’¾ Export JSON</button>
            <button class="btn btn-primary" onclick="saveKeys()">Save & Close</button>
        </div>
    </div>
</div>

<div id="codeModal" class="modal-overlay">
    <div class="modal" style="width: 700px;">
        <h2 style="margin-top:0" id="codeTitle">Javascript Integration</h2>
        <pre id="codeBlock" style="background:#1e1e1e; color:#d4d4d4; padding:15px; border-radius:8px; overflow-x:auto; font-size:13px;"></pre>
        <div style="margin-top:15px; text-align:right;">
             <button class="btn" onclick="document.getElementById('codeModal').style.display='none'">Close</button>
        </div>
    </div>
</div>

<script>
// --- 1. DEFINITIONS ---
// We use "Pointers" that redirect to latest versions automatically.
const providers = [
    {
        id: "gemini",
        name: "Google Gemini",
        // 'gemini-1.5-flash' is an ALIAS. It always points to the latest stable Flash.
        pointers: ["gemini-1.5-flash", "gemini-1.5-pro", "gemini-2.0-flash-exp"], 
        endpoint: "https://generativelanguage.googleapis.com/v1beta/models/{model}:generateContent?key={key}",
        testBody: (m) => ({ contents: [{ parts: [{ text: "Hello" }] }] })
    },
    {
        id: "groq",
        name: "Groq",
        // Groq uses specific IDs, but these are the main ones.
        pointers: ["llama-3.3-70b-versatile", "llama-3.1-8b-instant", "mixtral-8x7b-32768"],
        endpoint: "https://api.groq.com/openai/v1/chat/completions",
        testBody: (m) => ({ model: m, messages: [{ role: "user", content: "Hi" }] })
    },
    {
        id: "openai",
        name: "OpenAI",
        // 'gpt-4o' and 'gpt-4o-mini' are ALIASES to the current version.
        pointers: ["gpt-4o", "gpt-4o-mini", "gpt-3.5-turbo"],
        endpoint: "https://api.openai.com/v1/chat/completions",
        testBody: (m) => ({ model: m, messages: [{ role: "user", content: "Hi" }] })
    },
    {
        id: "anthropic",
        name: "Anthropic",
        // 'latest' aliases prevent breaking when they release minor updates.
        pointers: ["claude-3-5-sonnet-latest", "claude-3-5-haiku-latest"],
        endpoint: "https://api.anthropic.com/v1/messages",
        headers: { "x-api-version": "2023-06-01", "anthropic-dangerously-allow-browser": "true" },
        testBody: (m) => ({ model: m, max_tokens: 50, messages: [{ role: "user", content: "Hi" }] })
    },
    {
        id: "deepseek",
        name: "DeepSeek",
        pointers: ["deepseek-chat"], // Usually points to V3
        endpoint: "https://api.deepseek.com/chat/completions",
        testBody: (m) => ({ model: m, messages: [{ role: "user", content: "Hi" }] })
    },
    {
        id: "openrouter",
        name: "OpenRouter",
        pointers: ["google/gemini-2.0-flash-exp:free", "openai/gpt-4o"],
        endpoint: "https://openrouter.ai/api/v1/chat/completions",
        testBody: (m) => ({ model: m, messages: [{ role: "user", content: "Hi" }] })
    }
];

let appState = {
    keys: {},
    customModels: {}, // Structure: { "gemini": ["my-custom-model"], "groq": [...] }
    selectedModels: {}
};

// --- 2. INIT & RENDER ---
document.addEventListener("DOMContentLoaded", () => {
    loadState();
    renderTable();
});

function renderTable() {
    const tbody = document.getElementById("tableBody");
    tbody.innerHTML = "";

    providers.forEach((p, idx) => {
        // Merge Defaults + Custom Models
        const userCustoms = appState.customModels[p.id] || [];
        const allModels = [...new Set([...p.pointers, ...userCustoms])]; // Unique list
        
        // Build Options
        const currentSelection = appState.selectedModels[p.id] || allModels[0];
        const optionsHtml = allModels.map(m => 
            `<option value="${m}" ${m === currentSelection ? "selected" : ""}>${m}</option>`
        ).join("");

        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td><strong>${p.name}</strong></td>
            <td>
                <div class="model-container">
                    <select id="select-${idx}" class="model-select" onchange="updateSelection('${p.id}', this.value)">
                        ${optionsHtml}
                    </select>
                    <button class="btn btn-icon" title="Add Custom Model Alias" onclick="addCustomModel('${p.id}')">ï¼‹</button>
                </div>
            </td>
            <td><span id="status-${idx}" class="badge badge-idle">Idle</span></td>
            <td id="lat-${idx}" style="font-family:monospace">--</td>
            <td><button class="btn" onclick="showCode(${idx})">&lt;/&gt; Code</button></td>
        `;
        tbody.appendChild(tr);
    });
}

// --- 3. CORE LOGIC ---

// Add a new model alias manually via prompt
function addCustomModel(providerId) {
    const newModel = prompt(`Enter new Model ID for ${providerId} (e.g., 'gpt-5-preview'):`);
    if(newModel && newModel.trim() !== "") {
        if(!appState.customModels[providerId]) appState.customModels[providerId] = [];
        appState.customModels[providerId].push(newModel.trim());
        appState.selectedModels[providerId] = newModel.trim(); // Auto select it
        saveState();
        renderTable();
    }
}

function updateSelection(pid, val) {
    appState.selectedModels[pid] = val;
    saveState();
}

async function runGlobalTest() {
    const btn = document.querySelector('.btn-primary');
    btn.innerHTML = "â³ Testing...";
    
    // Run all tests in parallel
    await Promise.all(providers.map((p, idx) => testProvider(p, idx)));
    
    btn.innerHTML = "âš¡ Run System Check";
}

async function testProvider(p, idx) {
    const statusEl = document.getElementById(`status-${idx}`);
    const latEl = document.getElementById(`lat-${idx}`);
    const model = document.getElementById(`select-${idx}`).value;
    const key = appState.keys[p.id] || "";

    statusEl.className = "badge badge-load";
    statusEl.innerText = "Testing";
    
    const start = performance.now();

    try {
        let url = p.endpoint.replace("{model}", model).replace("{key}", key);
        let headers = { "Content-Type": "application/json" };
        
        // Auth Handling
        if (p.id !== 'gemini' && key) headers["Authorization"] = `Bearer ${key}`;
        if (p.id === 'anthropic') {
            if(key) headers["x-api-key"] = key;
            delete headers["Authorization"];
            Object.assign(headers, p.headers);
        }

        const res = await fetch(url, {
            method: "POST",
            headers: headers,
            body: JSON.stringify(p.testBody(model))
        });

        const duration = ((performance.now() - start) / 1000).toFixed(2);
        
        if(res.ok) {
            statusEl.className = "badge badge-ok";
            statusEl.innerText = "ONLINE";
            latEl.innerText = duration + "s";
            latEl.style.color = "green";
        } else {
            // If CORS fails, it usually throws in the catch block, but 4xx/5xx come here
            const txt = await res.text();
            throw new Error(res.status); 
        }

    } catch(e) {
        statusEl.className = "badge badge-err";
        latEl.innerText = "Fail";
        latEl.style.color = "red";
        
        // Friendly CORS warning for browser limitations
        if(e.message.includes("Failed to fetch") && (p.id === 'openai' || p.id === 'anthropic')) {
             statusEl.innerText = "CORS Block";
             statusEl.title = "Browser blocked this request. This code works on a server.";
        } else {
             statusEl.innerText = "ERROR";
        }
    }
}

// --- 4. STATE MANAGEMENT (JSON IMPORT/EXPORT) ---

function loadState() {
    const raw = localStorage.getItem("ai_pulse_v4_config");
    if(raw) {
        const data = JSON.parse(raw);
        appState.keys = data.keys || {};
        appState.customModels = data.custom_models || {};
        appState.selectedModels = data.selected_models || {};
    }
}

function saveState() {
    localStorage.setItem("ai_pulse_v4_config", JSON.stringify({
        keys: appState.keys,
        custom_models: appState.customModels,
        selected_models: appState.selectedModels
    }));
}

function handleImport(input) {
    const file = input.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const json = JSON.parse(e.target.result);
            // Merge logic
            if(json.keys) appState.keys = { ...appState.keys, ...json.keys };
            if(json.custom_models) appState.customModels = { ...appState.customModels, ...json.custom_models };
            saveState();
            renderTable();
            alert("Configuration Imported Successfully!");
        } catch(err) { alert("Invalid JSON file"); }
    };
    reader.readAsText(file);
}

function exportConfig() {
    const exportData = {
        keys: appState.keys,
        custom_models: appState.customModels
    };
    const blob = new Blob([JSON.stringify(exportData, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'ai_pulse_config.json';
    a.click();
}

// --- 5. MODALS ---

function openKeyModal() {
    const container = document.getElementById("keyInputs");
    container.innerHTML = "";
    providers.forEach(p => {
        const div = document.createElement("div");
        div.className = "key-row";
        div.innerHTML = `
            <label>${p.name}</label>
            <input type="password" id="key-${p.id}" value="${appState.keys[p.id] || ''}" placeholder="sk-...">
        `;
        container.appendChild(div);
    });
    document.getElementById("keyModal").style.display = "flex";
}

function saveKeys() {
    providers.forEach(p => {
        const val = document.getElementById(`key-${p.id}`).value.trim();
        if(val) appState.keys[p.id] = val;
        else delete appState.keys[p.id];
    });
    saveState();
    document.getElementById("keyModal").style.display = "none";
}

function showCode(idx) {
    const p = providers[idx];
    const model = document.getElementById(`select-${idx}`).value;
    const key = appState.keys[p.id] || "YOUR_API_KEY";
    
    // Generate Snippet
    let code = `// Javascript Fetch Example for ${p.name} (${model})\n\n`;
    let url = p.endpoint.replace("{model}", model).replace("{key}", "${key}"); // Don't expose real key if not needed
    if(p.id === 'gemini') url = p.endpoint.replace("{model}", model).replace("{key}", "YOUR_API_KEY");
    
    let headers = { "Content-Type": "application/json" };
    if(p.id !== 'gemini') headers["Authorization"] = "Bearer YOUR_API_KEY";
    if(p.id === 'anthropic') {
        headers["x-api-key"] = "YOUR_API_KEY";
        delete headers["Authorization"];
        Object.assign(headers, p.headers);
    }
    
    code += `const url = "${url}";\n`;
    code += `const headers = ${JSON.stringify(headers, null, 2)};\n`;
    code += `const body = ${JSON.stringify(p.testBody(model), null, 2)};\n\n`;
    code += `fetch(url, { method: "POST", headers, body: JSON.stringify(body) })\n`;
    code += `  .then(r => r.json())\n  .then(d => console.log(d));`;
    
    document.getElementById("codeBlock").innerText = code;
    document.getElementById("codeModal").style.display = "flex";
}
</script>

</body>
</html>
