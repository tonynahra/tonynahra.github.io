<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Pulse | v3.0 Enterprise</title>
    <style>
        :root {
            --bg-body: #f8f9fa;
            --bg-card: #ffffff;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --accent: #2563eb;
            --accent-hover: #1d4ed8;
            --success: #198754;
            --error: #dc3545;
            --warning: #ffc107;
            --border: #dee2e6;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-primary);
            margin: 0;
            padding: 20px;
        }

        /* --- Layout --- */
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-card);
            padding: 15px 25px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-bottom: 25px;
        }

        .brand h1 { margin: 0; font-size: 22px; font-weight: 700; letter-spacing: -0.5px; }
        .brand span { font-size: 13px; color: var(--text-secondary); background: #e9ecef; padding: 4px 8px; border-radius: 6px; margin-left: 10px; }

        .actions { display: flex; gap: 12px; }

        /* --- Buttons --- */
        .btn {
            border: 1px solid var(--border);
            background: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn:hover { background: #f8f9fa; border-color: #adb5bd; }
        .btn-primary { background: var(--accent); color: white; border-color: var(--accent); }
        .btn-primary:hover { background: var(--accent-hover); }
        .btn-sm { padding: 4px 10px; font-size: 12px; }
        .btn-test-all { background: #212529; color: white; border-color: #212529; }
        .btn-test-all:hover { background: #000; }

        /* --- Main Table --- */
        .dashboard {
            background: var(--bg-card);
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.02);
            overflow: hidden;
        }

        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 18px 25px; background: #f8f9fa; color: var(--text-secondary); font-size: 13px; text-transform: uppercase; font-weight: 600; }
        td { padding: 16px 25px; border-bottom: 1px solid var(--border); vertical-align: middle; }
        tr:last-child td { border-bottom: none; }
        
        .provider-name { font-weight: 600; font-size: 15px; display: block; }
        .provider-meta { font-size: 12px; color: var(--text-secondary); margin-top: 4px; }
        
        .model-selector {
            width: 100%; max-width: 250px; padding: 8px;
            border: 1px solid var(--border); border-radius: 6px; font-size: 13px;
        }

        .status-pill {
            display: inline-flex; align-items: center; justify-content: center;
            padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: 600; width: 80px;
        }
        .status-idle { background: #e9ecef; color: var(--text-secondary); }
        .status-success { background: #d1e7dd; color: var(--success); }
        .status-error { background: #f8d7da; color: var(--error); }
        .status-loading { background: #e2e3e5; color: var(--text-primary); animation: pulse 1.5s infinite; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* --- Modals --- */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1000;
            justify-content: center; align-items: center; backdrop-filter: blur(2px);
        }
        .modal {
            background: white; width: 700px; max-width: 90%;
            border-radius: 12px; padding: 25px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            max-height: 85vh; overflow-y: auto;
        }
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 20px; align-items: center; border-bottom: 1px solid var(--border); padding-bottom: 15px; }
        
        /* Code Block Styling */
        pre {
            background: #2d2d2d; color: #ccc;
            padding: 15px; border-radius: 8px;
            font-size: 13px; overflow-x: auto;
            border: 1px solid #444;
        }
        .code-keyword { color: #cc99cd; }
        .code-string { color: #7ec699; }
        .code-func { color: #f08d49; }
        
        .key-input { width: 95%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; margin-bottom: 10px; font-family: monospace; }
    </style>
</head>
<body>

<div id="keyModal" class="modal-overlay">
    <div class="modal" style="width: 500px;">
        <div class="modal-header">
            <h2 style="margin:0">üîê Secure Vault</h2>
            <button class="btn btn-sm" onclick="toggleModal('keyModal', false)">‚úñ</button>
        </div>
        <p style="font-size: 13px; color: #666; margin-bottom: 20px;">
            Keys are stored in your browser's LocalStorage.
        </p>
        <div id="keyInputsContainer"></div>
        <div style="margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px;">
            <button class="btn" onclick="exportKeys()">üíæ Backup</button>
            <button class="btn btn-primary" onclick="saveKeysAndClose()">Save Keys</button>
        </div>
    </div>
</div>

<div id="codeModal" class="modal-overlay">
    <div class="modal">
        <div class="modal-header">
            <h2 style="margin:0" id="codeModalTitle">Integration</h2>
            <button class="btn btn-sm" onclick="toggleModal('codeModal', false)">‚úñ</button>
        </div>
        
        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <button class="btn btn-primary" id="modalTestBtn" onclick="runSingleTestFromModal()">‚ñ∂ Run Live Test</button>
            <span id="modalStatus" style="align-self: center; font-weight: bold; font-size: 14px;"></span>
        </div>

        <h4 style="margin: 0 0 10px 0;">Generated JavaScript Code</h4>
        <pre id="codeBlock"></pre>

        <h4 style="margin: 15px 0 5px 0;">Response Output</h4>
        <div id="modalOutput" style="background: #f8f9fa; padding: 10px; border-radius: 6px; height: 100px; overflow-y: auto; font-family: monospace; font-size: 12px; border: 1px solid var(--border);">
            Click 'Run Live Test' to see response here...
        </div>
    </div>
</div>

<div class="header-bar">
    <div class="brand">
        <h1>AI Pulse</h1>
        <span>v3.0</span>
    </div>
    <div class="actions">
        <input type="file" id="fileInput" accept=".json" style="display:none" onchange="importKeys(this)">
        <button class="btn" onclick="document.getElementById('fileInput').click()">üìÇ Import</button>
        <button class="btn" onclick="toggleModal('keyModal', true)">üîë API Keys</button>
        <button class="btn btn-test-all" onclick="runGlobalTest()">‚ö° Run System Check</button>
    </div>
</div>

<div class="dashboard">
    <table id="mainTable">
        <thead>
            <tr>
                <th width="20%">Provider</th>
                <th width="25%">Model Alias</th>
                <th width="25%">Limits</th>
                <th width="10%">Status</th>
                <th width="10%">Latency</th>
                <th width="10%">Integration</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>
</div>

<script>
    // --- 1. DATA DEFINITIONS ---
    const providers = [
        {
            id: "gemini",
            name: "Google Gemini",
            limits: "Free: 15 RPM",
            pointers: ["gemini-1.5-flash", "gemini-1.5-pro"],
            endpoint: "https://generativelanguage.googleapis.com/v1beta/models/{model}:generateContent?key={key}",
            method: "POST",
            authType: "query", // key in url
            testBody: (m) => ({ contents: [{ parts: [{ text: "Hello" }] }] })
        },
        {
            id: "groq",
            name: "Groq",
            limits: "Free: 30 RPM",
            pointers: ["llama-3.3-70b-versatile", "mixtral-8x7b-32768"],
            endpoint: "https://api.groq.com/openai/v1/chat/completions",
            method: "POST",
            authType: "bearer",
            testBody: (m) => ({ model: m, messages: [{ role: "user", content: "Hi" }] })
        },
        {
            id: "openai",
            name: "OpenAI",
            limits: "Paid Only",
            pointers: ["gpt-4o", "gpt-4o-mini"],
            endpoint: "https://api.openai.com/v1/chat/completions",
            method: "POST",
            authType: "bearer",
            testBody: (m) => ({ model: m, messages: [{ role: "user", content: "Hi" }] })
        },
        {
            id: "anthropic",
            name: "Anthropic",
            limits: "Paid Only",
            pointers: ["claude-3-5-sonnet-latest"],
            endpoint: "https://api.anthropic.com/v1/messages",
            method: "POST",
            authType: "header-custom",
            headers: { "x-api-version": "2023-06-01", "anthropic-dangerously-allow-browser": "true" },
            testBody: (m) => ({ model: m, max_tokens: 50, messages: [{ role: "user", content: "Hi" }] })
        },
        {
            id: "deepseek",
            name: "DeepSeek",
            limits: "Cheap",
            pointers: ["deepseek-chat"],
            endpoint: "https://api.deepseek.com/chat/completions",
            method: "POST",
            authType: "bearer",
            testBody: (m) => ({ model: m, messages: [{ role: "user", content: "Hi" }] })
        },
        {
            id: "openrouter",
            name: "OpenRouter",
            limits: "Varies",
            pointers: ["google/gemini-2.0-flash-exp:free", "meta-llama/llama-3.2-11b-vision-instruct:free"],
            endpoint: "https://openrouter.ai/api/v1/chat/completions",
            method: "POST",
            authType: "bearer",
            testBody: (m) => ({ model: m, messages: [{ role: "user", content: "Hi" }] })
        }
    ];

    let apiKeys = {};
    let currentModalProviderIndex = -1;

    // --- 2. INIT ---
    document.addEventListener("DOMContentLoaded", () => {
        const storedKeys = localStorage.getItem("ai_pulse_keys");
        if (storedKeys) apiKeys = JSON.parse(storedKeys);
        renderTable();
        renderKeyInputs();
    });

    // --- 3. RENDER LOGIC ---
    function renderTable() {
        const tbody = document.getElementById("tableBody");
        tbody.innerHTML = "";
        
        // Load saved model selections
        const savedSelections = JSON.parse(localStorage.getItem("ai_pulse_selections") || "{}");

        providers.forEach((p, index) => {
            const tr = document.createElement("tr");
            
            // Pointers Dropdown
            const options = p.pointers.map(ptr => `<option value="${ptr}">${ptr}</option>`).join("");
            
            tr.innerHTML = `
                <td>
                    <span class="provider-name">${p.name}</span>
                </td>
                <td>
                    <select id="model-${index}" class="model-selector" onchange="saveSelections()">${options}</select>
                </td>
                <td style="font-size:13px; color:#666;">${p.limits}</td>
                <td><div id="status-${index}" class="status-pill status-idle">Idle</div></td>
                <td id="latency-${index}" style="font-family:monospace;">--</td>
                <td>
                    <button class="btn btn-sm" onclick="openCodeModal(${index})">
                        &lt;/&gt; Code & Test
                    </button>
                </td>
            `;
            tbody.appendChild(tr);

            // Restore selection
            if(savedSelections[p.id]) {
                const sel = document.getElementById(`model-${index}`);
                if(sel) sel.value = savedSelections[p.id];
            }
        });
    }

    function renderKeyInputs() {
        const container = document.getElementById("keyInputsContainer");
        container.innerHTML = "";
        providers.forEach(p => {
            const div = document.createElement("div");
            div.innerHTML = `
                <label style="font-size:12px; font-weight:600;">${p.name}</label>
                <input type="password" id="key-input-${p.id}" class="key-input" placeholder="sk-..." value="${apiKeys[p.id] || ''}">
            `;
            container.appendChild(div);
        });
    }

    // --- 4. TESTING LOGIC ---
    async function runGlobalTest() {
        const btn = document.querySelector('.btn-test-all');
        btn.innerHTML = "‚è≥ Running...";
        btn.disabled = true;

        await Promise.all(providers.map((p, idx) => runTest(idx)));

        btn.innerHTML = "‚ö° Run System Check";
        btn.disabled = false;
    }

    async function runTest(index) {
        const p = providers[index];
        const key = apiKeys[p.id] || ""; // Allow empty key
        const model = document.getElementById(`model-${index}`).value;
        const statusEl = document.getElementById(`status-${index}`);
        const latencyEl = document.getElementById(`latency-${index}`);

        statusEl.className = "status-pill status-loading";
        statusEl.innerText = "Testing";
        
        const start = performance.now();

        try {
            // Build Request
            let url = p.endpoint.replace("{model}", model).replace("{key}", key);
            let headers = { "Content-Type": "application/json" };
            
            if (p.authType === "bearer" && key) headers["Authorization"] = `Bearer ${key}`;
            if (p.authType === "header-custom") {
                if(key) headers["x-api-key"] = key;
                Object.assign(headers, p.headers || {});
            }

            const response = await fetch(url, {
                method: p.method,
                headers: headers,
                body: JSON.stringify(p.testBody(model))
            });

            const duration = ((performance.now() - start) / 1000).toFixed(2);

            if (response.ok) {
                statusEl.className = "status-pill status-success";
                statusEl.innerText = "ONLINE";
                latencyEl.innerText = duration + "s";
                latencyEl.style.color = "green";
                return { success: true, msg: "OK", duration };
            } else {
                throw new Error(response.status);
            }
        } catch (e) {
            statusEl.className = "status-pill status-error";
            statusEl.innerText = e.message || "ERR";
            latencyEl.innerText = "Fail";
            latencyEl.style.color = "red";
            return { success: false, msg: e.message };
        }
    }

    // --- 5. MODAL & CODE GENERATION ---
    function openCodeModal(index) {
        currentModalProviderIndex = index;
        const p = providers[index];
        const model = document.getElementById(`model-${index}`).value;
        const key = apiKeys[p.id] || "YOUR_API_KEY";

        document.getElementById("codeModalTitle").innerText = `${p.name} Integration`;
        document.getElementById("modalOutput").innerText = "Click 'Run Live Test' to see response here...";
        document.getElementById("modalStatus").innerText = "";

        // Generate Code String
        let code = `// ${p.name} Javascript Example\nconst url = "${p.endpoint.replace("{model}", model).replace("{key}", "${key}")}";\n`;
        
        let headerObj = { "Content-Type": "application/json" };
        if(p.authType === "bearer") headerObj["Authorization"] = "Bearer " + (key === "YOUR_API_KEY" ? key : "${key}");
        if(p.authType === "header-custom") {
            headerObj["x-api-key"] = (key === "YOUR_API_KEY" ? key : "${key}");
            Object.assign(headerObj, p.headers || {});
        }

        code += `const headers = ${JSON.stringify(headerObj, null, 2)};\n`;
        code += `const body = ${JSON.stringify(p.testBody(model), null, 2)};\n\n`;
        code += `fetch(url, { method: "POST", headers, body: JSON.stringify(body) })\n`;
        code += `  .then(response => response.json())\n`;
        code += `  .then(data => console.log(data));`;

        // Syntax Highlighting (Basic)
        // Note: For real highlighting we'd use a library, here we do simple regex replacement
        code = code.replace(/const|let|var|function|return/g, '<span class="code-keyword">$&</span>');
        code = code.replace(/"[^"]*"/g, '<span class="code-string">$&</span>');
        code = code.replace(/fetch|console\.log/g, '<span class="code-func">$&</span>');

        document.getElementById("codeBlock").innerHTML = code;
        toggleModal('codeModal', true);
    }

    async function runSingleTestFromModal() {
        if(currentModalProviderIndex === -1) return;
        
        const outputDiv = document.getElementById("modalOutput");
        outputDiv.innerHTML = "‚è≥ Sending request...";
        
        // Reuse logic but capture full response text
        const p = providers[currentModalProviderIndex];
        const index = currentModalProviderIndex;
        const key = apiKeys[p.id] || "";
        const model = document.getElementById(`model-${index}`).value;

        try {
            let url = p.endpoint.replace("{model}", model).replace("{key}", key);
            let headers = { "Content-Type": "application/json" };
            if (p.authType === "bearer" && key) headers["Authorization"] = `Bearer ${key}`;
            if (p.authType === "header-custom") {
                if(key) headers["x-api-key"] = key;
                Object.assign(headers, p.headers || {});
            }

            const response = await fetch(url, {
                method: p.method,
                headers: headers,
                body: JSON.stringify(p.testBody(model))
            });
            
            const data = await response.json();
            
            // Show result
            outputDiv.innerText = JSON.stringify(data, null, 2);
            document.getElementById("modalStatus").innerText = response.ok ? "‚úÖ Success" : "‚ùå Error";
            document.getElementById("modalStatus").style.color = response.ok ? "green" : "red";
            
            // Update main table too
            const statusEl = document.getElementById(`status-${index}`);
            if(response.ok) {
                statusEl.className = "status-pill status-success";
                statusEl.innerText = "ONLINE";
            } else {
                statusEl.className = "status-pill status-error";
                statusEl.innerText = response.status;
            }

        } catch (e) {
            outputDiv.innerText = "Error: " + e.message;
        }
    }

    // --- 6. UTILS ---
    function toggleModal(id, show) {
        document.getElementById(id).style.display = show ? "flex" : "none";
    }

    function saveKeysAndClose() {
        providers.forEach(p => {
            const val = document.getElementById(`key-input-${p.id}`).value.trim();
            if(val) apiKeys[p.id] = val;
            else delete apiKeys[p.id];
        });
        localStorage.setItem("ai_pulse_keys", JSON.stringify(apiKeys));
        toggleModal('keyModal', false);
    }

    function saveSelections() {
        const sels = {};
        providers.forEach((p, i) => sels[p.id] = document.getElementById(`model-${i}`).value);
        localStorage.setItem("ai_pulse_selections", JSON.stringify(sels));
    }

    function exportKeys() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(apiKeys));
        const dl = document.createElement('a');
        dl.setAttribute("href", dataStr);
        dl.setAttribute("download", "ai_pulse_keys.json");
        document.body.appendChild(dl);
        dl.click();
        dl.remove();
    }

    function importKeys(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                apiKeys = JSON.parse(e.target.result);
                localStorage.setItem("ai_pulse_keys", JSON.stringify(apiKeys));
                location.reload();
            } catch(e) { alert("Invalid JSON"); }
        };
        reader.readAsText(file);
    }
</script>
</body>
</html>
