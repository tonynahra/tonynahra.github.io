<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Pulse v5 | Pulse & Playground</title>
    <style>
        :root {
            --bg-body: #f3f4f6;
            --bg-card: #ffffff;
            --text-main: #111827;
            --text-sub: #6b7280;
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --border: #e5e7eb;
            --code-bg: #1e1e1e;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
        }

        /* --- Header --- */
        .header {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--bg-card); padding: 15px 25px; border-radius: 12px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); margin-bottom: 25px;
        }
        .header h1 { margin: 0; font-size: 22px; font-weight: 700; color: #1f2937; }

        /* --- Buttons --- */
        .btn {
            padding: 8px 16px; border-radius: 6px; border: 1px solid var(--border);
            background: white; cursor: pointer; font-weight: 600; font-size: 13px;
            transition: 0.15s; display: inline-flex; align-items: center; gap: 6px; color: #374151;
        }
        .btn:hover { background: #f9fafb; border-color: #d1d5db; color: #111827; }
        .btn-primary { background: var(--primary); color: white; border: 1px solid var(--primary); }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-sm { padding: 4px 10px; font-size: 12px; }
        .btn-link { border: none; background: none; color: var(--primary); padding: 0; text-decoration: underline; font-size: 12px; }

        /* --- Table --- */
        .card { background: var(--bg-card); border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); overflow: hidden; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { background: #f9fafb; padding: 12px 20px; text-align: left; color: var(--text-sub); font-weight: 600; text-transform: uppercase; font-size: 11px; letter-spacing: 0.05em; border-bottom: 1px solid var(--border); }
        td { padding: 14px 20px; border-bottom: 1px solid var(--border); vertical-align: middle; }
        tr:last-child td { border-bottom: none; }
        tr:hover { background: #f9fafb; }

        /* --- Inputs & Selects --- */
        .model-select { padding: 6px 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 13px; max-width: 220px; width: 100%; }
        .status-badge { padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 700; text-transform: uppercase; }
        .status-idle { background: #e5e7eb; color: #6b7280; }
        .status-ok { background: #dcfce7; color: #15803d; }
        .status-err { background: #fee2e2; color: #b91c1c; }
        .status-load { background: #e0f2fe; color: #0369a1; }

        /* --- Modal --- */
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 50; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .modal { background: white; width: 800px; max-width: 95%; height: 85vh; border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        .modal-header { padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #f9fafb; }
        .modal-body { padding: 20px; overflow-y: auto; flex: 1; display: flex; flex-direction: column; gap: 15px; }
        
        /* Modal Playground Areas */
        .playground-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding-bottom: 15px; border-bottom: 1px solid var(--border); }
        .control-group label { display: block; font-size: 12px; font-weight: 600; color: var(--text-sub); margin-bottom: 5px; }
        .modal-input { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; font-family: monospace; font-size: 13px; box-sizing: border-box; }
        
        .code-area { flex: 1; display: flex; flex-direction: column; gap: 5px; min-height: 200px; }
        .response-area { flex: 1; display: flex; flex-direction: column; gap: 5px; min-height: 150px; }
        
        pre { margin: 0; padding: 15px; border-radius: 8px; font-family: 'Menlo', 'Monaco', monospace; font-size: 12px; overflow: auto; height: 100%; box-sizing: border-box; }
        .pre-dark { background: var(--code-bg); color: #e5e7eb; border: 1px solid #333; }
        .pre-light { background: #f3f4f6; color: #1f2937; border: 1px solid var(--border); }

    </style>
</head>
<body>

<div class="header">
    <div style="display:flex; align-items:center; gap:10px;">
        <h1>AI Pulse v5</h1>
        <span style="font-size:11px; background:#e5e7eb; padding:2px 6px; border-radius:4px; font-weight:600;">Playground Edition</span>
    </div>
    <div style="display:flex; gap:10px;">
        <input type="file" id="fileInput" accept=".json" style="display:none" onchange="handleImport(this)">
        <button class="btn" onclick="document.getElementById('fileInput').click()">üìÇ Import</button>
        <button class="btn" onclick="openKeyModal()">üîë API Keys</button>
        <button class="btn btn-primary" onclick="runGlobalTest()">‚ö° Run System Check</button>
    </div>
</div>

<div class="card">
    <table id="mainTable">
        <thead>
            <tr>
                <th width="15%">Provider</th>
                <th width="30%">Model Alias (Stable Pointer)</th>
                <th width="15%">Docs</th>
                <th width="10%">Status</th>
                <th width="10%">Latency</th>
                <th width="20%">Actions</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>
</div>

<div id="keyModal" class="modal-overlay">
    <div class="modal" style="height: auto; max-height: 80vh; width: 500px;">
        <div class="modal-header">
            <h3 style="margin:0">üîê API Key Vault</h3>
            <button class="btn btn-sm" onclick="closeModal('keyModal')">‚úñ</button>
        </div>
        <div class="modal-body" id="keyInputs"></div>
        <div style="padding: 15px 20px; border-top: 1px solid var(--border); display:flex; justify-content:flex-end; gap:10px; background:#f9fafb;">
            <button class="btn" onclick="exportConfig()">üíæ Export JSON</button>
            <button class="btn btn-primary" onclick="saveKeys()">Save Keys</button>
        </div>
    </div>
</div>

<div id="playgroundModal" class="modal-overlay">
    <div class="modal">
        <div class="modal-header">
            <div style="display:flex; align-items:center; gap:10px;">
                <h3 style="margin:0" id="pgTitle">Playground</h3>
                <span class="status-badge status-idle" id="pgBadge">Ready</span>
            </div>
            <button class="btn btn-sm" onclick="closeModal('playgroundModal')">‚úñ</button>
        </div>
        
        <div class="modal-body">
            <div class="playground-controls">
                <div class="control-group">
                    <label>Provider</label>
                    <input type="text" id="pgProvider" class="modal-input" disabled style="background:#f3f4f6;">
                </div>
                <div class="control-group">
                    <label>Model ID (Edit to test new models)</label>
                    <input type="text" id="pgModel" class="modal-input" placeholder="e.g. gpt-4o" oninput="updateSnippet()">
                </div>
            </div>

            <div class="code-area">
                <label style="font-size:12px; font-weight:600; color:var(--text-sub);">JavaScript Snippet (Auto-updates)</label>
                <pre id="pgCode" class="pre-dark">// Code will appear here...</pre>
            </div>

            <div style="display:flex; justify-content:flex-end; gap:10px;">
                <button class="btn" onclick="copyCode()">üìã Copy Code</button>
                <button class="btn btn-primary" onclick="runPlaygroundTest()">‚ñ∂ Run Live Request</button>
            </div>

            <div class="response-area">
                <label style="font-size:12px; font-weight:600; color:var(--text-sub);">Live Response</label>
                <pre id="pgResponse" class="pre-light">Click 'Run Live Request' to test.</pre>
            </div>
        </div>
    </div>
</div>

<script>
// --- CONFIGURATION ---
const providers = [
    {
        id: "gemini",
        name: "Google Gemini",
        docs: "https://ai.google.dev/gemini-api/docs/models/gemini",
        pointers: ["gemini-1.5-flash", "gemini-1.5-pro", "gemini-2.0-flash-exp"],
        endpoint: "https://generativelanguage.googleapis.com/v1beta/models/{model}:generateContent?key={key}",
        testBody: (m) => ({ contents: [{ parts: [{ text: "Hello" }] }] })
    },
    {
        id: "groq",
        name: "Groq",
        docs: "https://console.groq.com/docs/models",
        pointers: ["llama-3.3-70b-versatile", "llama-3.1-8b-instant", "mixtral-8x7b-32768"],
        endpoint: "https://api.groq.com/openai/v1/chat/completions",
        testBody: (m) => ({ model: m, messages: [{ role: "user", content: "Hi" }] })
    },
    {
        id: "openai",
        name: "OpenAI",
        docs: "https://platform.openai.com/docs/models",
        pointers: ["gpt-4o", "gpt-4o-mini", "gpt-3.5-turbo"],
        endpoint: "https://api.openai.com/v1/chat/completions",
        testBody: (m) => ({ model: m, messages: [{ role: "user", content: "Hi" }] })
    },
    {
        id: "anthropic",
        name: "Anthropic",
        docs: "https://docs.anthropic.com/en/docs/about-claude/models",
        pointers: ["claude-3-5-sonnet-latest", "claude-3-5-haiku-latest"],
        endpoint: "https://api.anthropic.com/v1/messages",
        headers: { "x-api-version": "2023-06-01", "anthropic-dangerously-allow-browser": "true" },
        testBody: (m) => ({ model: m, max_tokens: 50, messages: [{ role: "user", content: "Hi" }] })
    },
    {
        id: "deepseek",
        name: "DeepSeek",
        docs: "https://api-docs.deepseek.com/",
        pointers: ["deepseek-chat"], 
        endpoint: "https://api.deepseek.com/chat/completions",
        testBody: (m) => ({ model: m, messages: [{ role: "user", content: "Hi" }] })
    },
    {
        id: "openrouter",
        name: "OpenRouter",
        docs: "https://openrouter.ai/models",
        pointers: ["google/gemini-2.0-flash-exp:free", "openai/gpt-4o"],
        endpoint: "https://openrouter.ai/api/v1/chat/completions",
        testBody: (m) => ({ model: m, messages: [{ role: "user", content: "Hi" }] })
    }
];

// --- STATE ---
let appState = {
    keys: {},
    customModels: {},
    selectedModels: {}
};

let currentPlaygroundIdx = -1; // Tracks which provider is open in modal

// --- INITIALIZATION ---
document.addEventListener("DOMContentLoaded", () => {
    loadState();
    renderTable();
});

// --- RENDER TABLE ---
function renderTable() {
    const tbody = document.getElementById("tableBody");
    tbody.innerHTML = "";

    providers.forEach((p, idx) => {
        // Models: Default + Custom
        const customs = appState.customModels[p.id] || [];
        const allModels = [...new Set([...p.pointers, ...customs])];
        
        // Selection Logic
        const selected = appState.selectedModels[p.id] || allModels[0];
        const options = allModels.map(m => `<option value="${m}" ${m===selected?"selected":""}>${m}</option>`).join("");

        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td style="font-weight:600;">${p.name}</td>
            <td>
                <div style="display:flex; gap:5px;">
                    <select id="sel-${idx}" class="model-select" onchange="updateSelection('${p.id}', this.value)">${options}</select>
                </div>
            </td>
            <td>
                <a href="${p.docs}" target="_blank" class="btn-link">View Models ‚Üó</a>
            </td>
            <td><span id="status-${idx}" class="status-badge status-idle">Idle</span></td>
            <td id="lat-${idx}" style="font-family:monospace; font-size:12px;">--</td>
            <td>
                <button class="btn btn-sm" onclick="openPlayground(${idx})">üõ†Ô∏è Code & Test</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

// --- GLOBAL TEST LOGIC ---
async function runGlobalTest() {
    const btn = document.querySelector('.btn-primary');
    const oldTxt = btn.innerText;
    btn.innerText = "‚è≥ Testing...";
    await Promise.all(providers.map((p, idx) => testProviderSingle(p, idx)));
    btn.innerText = oldTxt;
}

async function testProviderSingle(p, idx) {
    const statusEl = document.getElementById(`status-${idx}`);
    const latEl = document.getElementById(`lat-${idx}`);
    const model = document.getElementById(`sel-${idx}`).value;
    const key = appState.keys[p.id] || "";

    statusEl.className = "status-badge status-load"; statusEl.innerText = "Running";
    const start = performance.now();

    try {
        const { url, headers, body } = prepareRequest(p, model, key);
        const res = await fetch(url, { method: "POST", headers, body: JSON.stringify(body) });
        
        const duration = ((performance.now() - start) / 1000).toFixed(2);
        if(res.ok) {
            statusEl.className = "status-badge status-ok"; statusEl.innerText = "Online";
            latEl.innerText = duration + "s"; latEl.style.color = "green";
        } else {
            throw new Error(res.status);
        }
    } catch(e) {
        statusEl.className = "status-badge status-err"; statusEl.innerText = "Error";
        latEl.innerText = "Fail"; latEl.style.color = "red";
    }
}

// --- PLAYGROUND MODAL LOGIC ---
function openPlayground(idx) {
    currentPlaygroundIdx = idx;
    const p = providers[idx];
    const currentModel = document.getElementById(`sel-${idx}`).value;

    document.getElementById("pgTitle").innerText = `${p.name} Playground`;
    document.getElementById("pgProvider").value = p.name;
    document.getElementById("pgModel").value = currentModel;
    document.getElementById("pgResponse").innerText = "Ready to test...";
    document.getElementById("pgBadge").className = "status-badge status-idle";
    document.getElementById("pgBadge").innerText = "Idle";
    
    updateSnippet();
    openModal("playgroundModal");
}

function updateSnippet() {
    if(currentPlaygroundIdx === -1) return;
    const p = providers[currentPlaygroundIdx];
    const model = document.getElementById("pgModel").value;
    const key = appState.keys[p.id] || "YOUR_API_KEY";

    // Build visual snippet
    const { url, headers, body } = prepareRequest(p, model, key === "YOUR_API_KEY" ? "YOUR_API_KEY" : "${apiKey}");
    
    // Mask key in URL if gemini
    let displayUrl = url; 
    if(p.id === 'gemini') displayUrl = p.endpoint.replace("{model}", model).replace("{key}", "YOUR_API_KEY");

    let code = `// ${p.name} JavaScript Integration\n`;
    code += `const url = "${displayUrl}";\n`;
    code += `const headers = ${JSON.stringify(headers, null, 2)};\n`;
    code += `const body = ${JSON.stringify(body, null, 2)};\n\n`;
    code += `fetch(url, {\n  method: "POST",\n  headers: headers,\n  body: JSON.stringify(body)\n})\n`;
    code += `.then(response => response.json())\n.then(data => console.log(data));`;

    document.getElementById("pgCode").innerText = code;
}

async function runPlaygroundTest() {
    const p = providers[currentPlaygroundIdx];
    const model = document.getElementById("pgModel").value; // Use input value, not table value
    const key = appState.keys[p.id] || "";
    const badge = document.getElementById("pgBadge");
    const output = document.getElementById("pgResponse");

    output.innerText = "‚è≥ Sending request...";
    badge.className = "status-badge status-load"; badge.innerText = "Sending";

    try {
        const { url, headers, body } = prepareRequest(p, model, key);
        const res = await fetch(url, { method: "POST", headers, body: JSON.stringify(body) });
        const json = await res.json();
        
        output.innerText = JSON.stringify(json, null, 2);
        
        if(res.ok) {
            badge.className = "status-badge status-ok"; badge.innerText = "Success";
            // If this was a new model that succeeded, let's save it to custom models implicitly? 
            // Optional: User can manually add it later, but for now we just test.
        } else {
            badge.className = "status-badge status-err"; badge.innerText = "HTTP " + res.status;
        }
    } catch(e) {
        output.innerText = "Error: " + e.message;
        badge.className = "status-badge status-err"; badge.innerText = "Failed";
    }
}

// --- HELPER: Request Builder ---
function prepareRequest(p, model, key) {
    let url = p.endpoint.replace("{model}", model).replace("{key}", key);
    let headers = { "Content-Type": "application/json" };
    
    if(p.id !== 'gemini' && !url.includes("key=")) {
        if(key) headers["Authorization"] = `Bearer ${key}`;
    }
    
    if(p.id === 'anthropic') {
        if(key) headers["x-api-key"] = key;
        delete headers["Authorization"];
        Object.assign(headers, p.headers);
    }
    
    const body = p.testBody(model);
    return { url, headers, body };
}

// --- DATA MANAGEMENT ---
function loadState() {
    const raw = localStorage.getItem("ai_pulse_v5_cfg");
    if(raw) {
        const d = JSON.parse(raw);
        appState = { keys: d.keys||{}, customModels: d.customModels||{}, selectedModels: d.selectedModels||{} };
    }
}

function saveState() {
    localStorage.setItem("ai_pulse_v5_cfg", JSON.stringify(appState));
}

function updateSelection(pid, val) {
    appState.selectedModels[pid] = val;
    saveState();
}

function saveKeys() {
    providers.forEach(p => {
        const val = document.getElementById(`k-${p.id}`).value.trim();
        if(val) appState.keys[p.id] = val; else delete appState.keys[p.id];
    });
    saveState();
    closeModal("keyModal");
}

function handleImport(input) {
    const f = input.files[0];
    if(!f) return;
    const r = new FileReader();
    r.onload = (e) => {
        try {
            const d = JSON.parse(e.target.result);
            if(d.keys) appState.keys = { ...appState.keys, ...d.keys };
            if(d.customModels) appState.customModels = { ...appState.customModels, ...d.customModels };
            saveState();
            renderTable();
        } catch(e) { alert("Invalid JSON"); }
    };
    r.readAsText(f);
}

function exportConfig() {
    const blob = new Blob([JSON.stringify(appState, null, 2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'ai_pulse_config.json';
    a.click();
}

// --- UI UTILS ---
function openModal(id) { document.getElementById(id).style.display = "flex"; }
function closeModal(id) { document.getElementById(id).style.display = "none"; }
function openKeyModal() {
    const c = document.getElementById("keyInputs"); c.innerHTML = "";
    providers.forEach(p => {
        const div = document.createElement("div");
        div.style.marginBottom = "10px";
        div.innerHTML = `<label style="display:block;font-size:12px;font-weight:600;margin-bottom:4px;">${p.name}</label>
                         <input type="password" id="k-${p.id}" value="${appState.keys[p.id]||''}" class="modal-input" placeholder="sk-...">`;
        c.appendChild(div);
    });
    openModal("keyModal");
}
function copyCode() {
    navigator.clipboard.writeText(document.getElementById("pgCode").innerText);
    alert("Copied to clipboard!");
}
</script>
</body>
</html>
