<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AI Pulse | Admin Panel</title>
    <style>
        :root { --bg:#f1f5f9; --surface:#ffffff; --text:#334155; --primary:#2563eb; --success:#16a34a; --danger:#dc2626; --border:#cbd5e1; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); padding: 30px; }
        
        /* Header */
        .header { display: flex; justify-content: space-between; align-items: center; background: var(--surface); padding: 15px 25px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .header h1 { margin: 0; font-size: 20px; color: #1e293b; }
        
        /* Buttons */
        .btn { padding: 8px 14px; border-radius: 6px; border: 1px solid var(--border); cursor: pointer; background: white; font-size: 13px; font-weight: 500; transition: 0.1s; }
        .btn:hover { background: #f8fafc; border-color: #94a3b8; }
        .btn-primary { background: var(--primary); color: white; border-color: var(--primary); } .btn-primary:hover { background: #1d4ed8; }
        .btn-save { background: #0f172a; color: white; border-color: #0f172a; } .btn-save:hover { background: #334155; }
        .btn-code { background: #334155; color: white; border-color: #334155; } .btn-code:hover { background: #475569; }
        .btn-link { border: none; background: none; color: var(--primary); text-decoration: underline; padding: 0; font-size: 12px; }
        .btn-close-x { border: none; background: transparent; font-size: 24px; color: #64748b; cursor: pointer; line-height: 1; padding: 0; }
        .btn-close-x:hover { color: #dc2626; }

        /* Status Pills */
        .status-pill { padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: 700; text-transform: uppercase; }
        .pass { background: #dcfce7; color: #166534; } 
        .fail { background: #fee2e2; color: #991b1b; } 
        .idle { background: #f1f5f9; color: #94a3b8; }
        
        /* Table */
        .card { background: white; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); overflow: hidden; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 14px 20px; text-align: left; border-bottom: 1px solid #e2e8f0; }
        th { background: #f8fafc; font-size: 12px; text-transform: uppercase; color: #64748b; font-weight: 700; }
        tr:last-child td { border-bottom: none; }
        
        /* Zebra Striping */
        tbody tr:nth-child(even) { background-color: #f8fafc; }
        tbody tr:hover { background-color: #f1f5f9; }

        /* Modal */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; width: 900px; max-width: 95%; padding: 30px; border-radius: 12px; display: flex; flex-direction: column; gap: 20px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.2); max-height: 95vh; }
        
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e2e8f0; padding-bottom: 15px; margin-bottom: 5px; }
        .modal-header h3 { margin: 0; font-size: 24px; color: #0f172a; font-weight: 800; }
        
        .modal-label { font-size: 15px; font-weight: 700; color: #334155; display: block; margin-bottom: 8px; }

        pre { background: #1e293b; color: #e2e8f0; padding: 20px; border-radius: 8px; overflow-x: auto; font-family: monospace; font-size: 14px; margin: 0; height: 300px; line-height: 1.5; }
        select, input[type="text"] { padding: 10px; border-radius: 6px; border: 1px solid #cbd5e1; font-size: 14px; }
        
        /* Animation */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div class="header">
    <h1>AI Pulse Admin</h1>
    <div style="display:flex; gap:10px; align-items:center;">
        <span id="saveStatus" style="font-size:12px; color:#64748b; font-weight:500;"></span>
        <button class="btn btn-save" onclick="saveToServer()">üíæ Save Changes</button>
    </div>
</div>

<div class="card">
    <table>
        <thead>
            <tr>
                <th width="15%">Provider</th>
                <th width="25%">Model Selector</th>
                <th width="10%">Status</th>
                <th width="10%">Passing</th>
                <th width="15%">Last Pass</th>
                <th width="10%">Action</th>
                <th width="15%">Ref</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>
</div>

<div id="testModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">Test Provider</h3>
            <button class="btn-close-x" onclick="closeModal()">√ó</button>
        </div>

        <div style="background: #f8fafc; padding: 20px; border-radius: 8px; border: 1px solid #e2e8f0;">
            <label class="modal-label">Select Existing or Add New Model:</label>
            <div style="display:flex; gap:10px; margin-bottom: 10px;">
                <select id="modalSelector" style="flex:1;" onchange="syncInput()"></select>
            </div>
            <div style="display:flex; gap:10px;">
                <input type="text" id="modalNewInput" placeholder="Type new model ID..." style="flex:1; font-family:monospace;">
                <button class="btn" onclick="addNewModel()">+ Add & Select</button>
            </div>
        </div>
        
        <div style="display:flex; gap:10px; align-items:center; border-bottom: 1px solid #e2e8f0; padding-bottom: 20px;">
            <button class="btn btn-primary" style="padding: 10px 20px; font-size:14px;" onclick="runSecureTest()">‚ñ∂ Run Test</button>
            <button class="btn btn-code" style="padding: 10px 20px; font-size:14px;" onclick="toggleCodeView()"> { } Show Code</button>
            
            <div id="modalActions" style="display:none; gap:10px; margin-left: auto;" class="fade-in">
                <button class="btn" style="color:#16a34a; border-color:#16a34a;" onclick="markStatus('PASS')">‚úî Mark Pass</button>
                <button class="btn" style="color:#dc2626; border-color:#dc2626;" onclick="markStatus('FAIL')">‚úñ Mark Fail</button>
            </div>
        </div>
        
        <div id="viewOutput" class="fade-in" style="display:flex; flex-direction:column;">
             <label class="modal-label">Response Output:</label>
             <pre id="modalOutput">Ready...</pre>
        </div>

        <div id="viewCode" class="fade-in" style="display:none; flex-direction:column;">
            <label class="modal-label">Client-Side Integration Code (Direct API):</label>
            <pre id="codeSnippet" style="background: #0f172a; color: #a5b4fc;"></pre>
       </div>

    </div>
</div>

<script>
    let data = { providers: [] };
    let currentIdx = -1;

    // Load Public Data
    fetch('sources.json').then(r => r.json()).then(d => { data = d; render(); });

    function render() {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = "";
        
        data.providers.forEach((p, idx) => {
            const history = p.history || {};
            const models = p.models || [];
            
            // Default selection
            const selected = models[0] || ""; 
            
            // Status of selected
            let status = "IDLE";
            if (selected && history[selected]) status = history[selected].status;

            // Stats
            const passCount = Object.values(history).filter(h => h.status === 'PASS').length;
            
            // Last Pass Date
            let lastPassDate = "--";
            const passes = Object.values(history)
                .filter(h => h.status === 'PASS')
                .map(h => h.date)
                .sort().reverse();
            if(passes.length > 0) lastPassDate = passes[0];

            tbody.innerHTML += `
                <tr>
                    <td><strong>${p.name}</strong></td>
                    <td>
                        <select onchange="updateRowStatus(${idx}, this.value, this)">
                            ${models.map(m => {
                                const s = history[m] ? history[m].status : '';
                                const icon = s === 'PASS' ? '‚úÖ ' : (s === 'FAIL' ? '‚ùå ' : '');
                                return `<option value="${m}" ${m===selected?'selected':''}>${icon}${m}</option>`;
                            }).join('')}
                        </select>
                    </td>
                    <td><span class="status-pill ${status.toLowerCase()}" id="status-pill-${idx}">${status}</span></td>
                    <td><strong>${passCount}</strong> / ${models.length}</td>
                    <td style="font-size:12px; color:#64748b;">${lastPassDate}</td>
                    <td><button class="btn" onclick="openModal(${idx})">Test</button></td>
                    <td><a href="${p.docs}" target="_blank" class="btn-link">Latest Models ‚Üó</a></td>
                </tr>
            `;
        });
    }

    function updateRowStatus(idx, model, selectEl) {
        const history = data.providers[idx].history || {};
        const status = (history[model] && history[model].status) ? history[model].status : "IDLE";
        const pill = document.getElementById(`status-pill-${idx}`);
        pill.className = `status-pill ${status.toLowerCase()}`;
        pill.innerText = status;
    }

    // --- MODAL LOGIC ---

    function openModal(idx) {
        currentIdx = idx;
        const p = data.providers[idx];
        
        document.getElementById('modalTitle').innerText = `Test Provider: ${p.name}`;
        
        // Populate Dropdown
        const dl = document.getElementById('modalSelector');
        dl.innerHTML = p.models.map(m => `<option value="${m}">${m}</option>`).join('');
        
        // Sync Text Input
        syncInput();

        // Reset Views
        document.getElementById('modalActions').style.display = "none";
        document.getElementById('modalOutput').innerText = "Ready to test...";
        document.getElementById('viewOutput').style.display = "flex";
        document.getElementById('viewCode').style.display = "none";
        
        document.getElementById('testModal').style.display = "flex";
    }

    function syncInput() {
        const val = document.getElementById('modalSelector').value;
        document.getElementById('modalNewInput').value = val;
    }

    function addNewModel() {
        const p = data.providers[currentIdx];
        const val = document.getElementById('modalNewInput').value.trim();
        
        if (!val) return alert("Please enter a model ID");
        
        if (!p.models.includes(val)) {
            // Add to local data
            p.models.unshift(val); // Add to top
            
            // Re-render Modal Dropdown
            const dl = document.getElementById('modalSelector');
            dl.innerHTML = p.models.map(m => `<option value="${m}">${m}</option>`).join('');
            dl.value = val;
            
            // Re-render Main Table
            render();
            
            alert(`Added ${val}. Click 'Save Changes' to keep permanently.`);
        } else {
            alert("Model already exists.");
            document.getElementById('modalSelector').value = val;
        }
    }

    function closeModal() {
        document.getElementById('testModal').style.display = 'none';
    }

    function toggleCodeView() {
        const output = document.getElementById('viewOutput');
        const code = document.getElementById('viewCode');
        
        if (code.style.display === 'none') {
            output.style.display = 'none';
            code.style.display = 'flex';
            generateCodeSnippet();
        } else {
            code.style.display = 'none';
            output.style.display = 'flex';
        }
    }

    function generateCodeSnippet() {
        const p = data.providers[currentIdx];
        const model = document.getElementById('modalNewInput').value;
        
        // We use "YOUR_API_KEY" because the browser doesn't know the real key (it's in config.php)
        const url = p.endpoint.replace('{model}', model).replace('{key}', 'YOUR_API_KEY');
        
        let headers = { "Content-Type": "application/json" };
        if(p.authType === 'bearer') headers['Authorization'] = "Bearer YOUR_API_KEY";
        if(p.authType === 'header-custom') {
            headers['x-api-key'] = "YOUR_API_KEY";
            if(p.customHeaders) Object.assign(headers, p.customHeaders);
        }
        
        let body = JSON.parse(JSON.stringify(p.testBody).replace('{model}', model));

        let snippet = `// Direct API Call for ${p.name} (${model})\n`;
        snippet += `const url = "${url}";\n`;
        snippet += `const headers = ${JSON.stringify(headers, null, 2)};\n`;
        snippet += `const body = ${JSON.stringify(body, null, 2)};\n\n`;
        snippet += `fetch(url, {\n  method: "POST",\n  headers: headers,\n  body: JSON.stringify(body)\n})\n`;
        snippet += `.then(response => response.json())\n.then(data => console.log(data));`;
        
        document.getElementById('codeSnippet').innerText = snippet;
    }

    async function runSecureTest() {
        // Ensure we are viewing output, not code
        document.getElementById('viewOutput').style.display = 'flex';
        document.getElementById('viewCode').style.display = 'none';

        const p = data.providers[currentIdx];
        const model = document.getElementById('modalNewInput').value;
        const output = document.getElementById('modalOutput');
        
        output.innerText = "Requesting via proxy...";
        
        let bodyPayload = JSON.parse(JSON.stringify(p.testBody).replace('{model}', model));

        try {
            const res = await fetch('proxy.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    provider_id: p.id,
                    model: model,
                    body: bodyPayload
                })
            });
            
            const json = await res.json();
            output.innerText = JSON.stringify(json, null, 2);
            
            // SHOW BUTTONS NOW (Success)
            document.getElementById('modalActions').style.display = "flex";
            
        } catch(e) {
            output.innerText = "Error: " + e.message;
            
            // SHOW BUTTONS NOW (Even on error, so you can mark fail)
            document.getElementById('modalActions').style.display = "flex";
        }
    }

    function markStatus(status) {
        const p = data.providers[currentIdx];
        const model = document.getElementById('modalNewInput').value;
        if(!p.history) p.history = {};
        
        p.history[model] = { 
            status: status, 
            date: new Date().toLocaleDateString() + ' ' + new Date().toLocaleTimeString() 
        };
        
        render(); 
        closeModal();
    }

    async function saveToServer() {
        const statusEl = document.getElementById('saveStatus');
        statusEl.innerText = "Saving...";
        try {
            await fetch('save_data.php', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            statusEl.innerText = "Saved ‚úî";
            setTimeout(() => statusEl.innerText = "", 2000);
        } catch(e) {
            statusEl.innerText = "Error Saving";
            alert("Failed to save: " + e.message);
        }
    }
</script>
</body>
</html>
