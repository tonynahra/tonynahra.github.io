<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Pulse v9 | Dynamic Manager</title>
    <style>
        :root {
            --bg: #f8fafc;
            --surface: #ffffff;
            --text: #334155;
            --primary: #3b82f6;
            --success: #22c55e;
            --danger: #ef4444;
            --border: #e2e8f0;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 30px;
        }

        /* --- Header --- */
        .header {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--surface); padding: 15px 25px; border-radius: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); margin-bottom: 25px;
        }
        .header h1 { margin: 0; font-size: 20px; font-weight: 700; color: #1e293b; }

        /* --- Buttons --- */
        .btn {
            background: white; border: 1px solid var(--border); padding: 8px 14px;
            border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500;
            transition: 0.1s; display: inline-flex; align-items: center; gap: 6px;
        }
        .btn:hover { background: #f1f5f9; border-color: #cbd5e1; }
        .btn-primary { background: var(--primary); color: white; border-color: var(--primary); }
        .btn-primary:hover { background: #2563eb; }
        .btn-success { background: var(--success); color: white; border-color: var(--success); }
        .btn-success:hover { background: #16a34a; }
        .btn-danger { background: var(--danger); color: white; border-color: var(--danger); }
        .btn-danger:hover { background: #dc2626; }
        .btn-link { border: none; background: none; color: var(--primary); text-decoration: underline; padding: 0; cursor: pointer; }

        /* --- Table --- */
        .card { background: var(--surface); border-radius: 10px; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { text-align: left; padding: 14px 20px; background: #f8fafc; border-bottom: 1px solid var(--border); font-weight: 600; color: #64748b; font-size: 12px; text-transform: uppercase; }
        td { padding: 14px 20px; border-bottom: 1px solid var(--border); vertical-align: middle; }
        tr:last-child td { border-bottom: none; }
        
        .text-right { text-align: right; }
        .text-center { text-align: center; }

        /* --- Combobox --- */
        .combo-container { position: relative; width: 100%; max-width: 320px; }
        .input-combo { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; font-size: 13px; font-family: monospace; box-sizing: border-box; }

        /* --- Status Pills --- */
        .status-pill { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; text-transform: uppercase; }
        .st-idle { background: #f1f5f9; color: #64748b; }
        .st-ok { background: #dcfce7; color: #166534; }
        .st-err { background: #fee2e2; color: #991b1b; }
        .st-load { background: #e0f2fe; color: #075985; }

        /* --- Modal --- */
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 100; justify-content: center; align-items: center; }
        .modal { background: white; width: 800px; max-width: 90%; padding: 25px; border-radius: 12px; max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        
        pre { background: #1e293b; color: #e2e8f0; padding: 15px; border-radius: 8px; overflow-x: auto; font-size: 13px; font-family: monospace; margin: 0; }
        .alert-box { background: #fff7ed; border: 1px solid #fed7aa; color: #9a3412; padding: 12px; border-radius: 6px; font-size: 13px; margin-bottom: 20px; display: none; }
        
        .stat-pass { color: var(--success); font-weight: 700; }
        .stat-date { color: #64748b; font-size: 12px; }

        /* Animation for appearance */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="header">
    <div style="display:flex; align-items:center; gap:10px;">
        <h1>AI Pulse v9</h1>
        <span style="font-size:11px; background:#e2e8f0; padding:2px 8px; border-radius:4px;">Dynamic Manager</span>
    </div>
    <div style="display:flex; gap:10px;">
        <input type="file" id="sourceFile" accept=".json" style="display:none" onchange="loadExternalSource(this)">
        <button id="btnLoadSource" class="btn" onclick="document.getElementById('sourceFile').click()" style="display:none;">‚ö†Ô∏è Load sources.json</button>
        <button class="btn btn-primary" onclick="runSystemCheck()">‚ö° System Check</button>
    </div>
</div>

<div id="errorAlert" class="alert-box">
    <strong>Configuration Missing.</strong> Click "Load sources.json" above to load your provider list.
</div>

<div class="card">
    <table id="mainTable">
        <thead>
            <tr>
                <th width="15%">Provider</th>
                <th width="30%">Model Selector</th>
                <th width="10%">Status</th>
                <th width="10%">Latency</th>
                <th width="10%" class="text-right">Total Models</th>
                <th width="10%" class="text-right">Passing</th>
                <th width="15%" class="text-right">Last Pass</th>
                <th width="10%" class="text-center">Action</th>
            </tr>
        </thead>
        <tbody id="tableBody">
            <tr><td colspan="8" style="text-align:center; padding:30px; color:#94a3b8;">Waiting for configuration...</td></tr>
        </tbody>
    </table>
</div>

<div id="codeModal" class="modal-overlay">
    <div class="modal">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3 style="margin:0">Model Tester</h3>
            <button class="btn" onclick="document.getElementById('codeModal').style.display='none'">Close</button>
        </div>
        
        <div style="background:#f1f5f9; padding:15px; border-radius:8px; display:flex; gap:10px; flex-direction: column;">
            <label style="font-size:12px; font-weight:600; color:#64748b;">Select or Type Model ID:</label>
            <div style="display:flex; gap:10px;">
                <input list="modalModelList" id="modalModelInput" class="input-combo" placeholder="Type model ID..." onchange="updateSnippetFromInput()">
                <datalist id="modalModelList"></datalist>
                <button class="btn btn-primary" onclick="addNewModelFromModal()">ADD</button>
            </div>
            <div style="font-size:11px; color:#64748b;">Click ADD to save new model IDs to your local list.</div>
        </div>

        <div style="display:flex; gap:15px; align-items: center; margin-top:5px;">
            <button class="btn btn-primary" style="padding: 10px 20px;" onclick="runSingleTestFromModal()">‚ñ∂ Run Live Request</button>
            <span id="modalStatus" style="font-weight:bold; font-size:14px;"></span>
        </div>

        <div id="actionButtons" style="display:none; gap:10px; margin-top:0px;" class="fade-in">
            <button class="btn btn-success" onclick="markModelStatus('PASS')">‚úî Mark Pass</button>
            <button class="btn btn-danger" onclick="markModelStatus('FAIL')">‚úñ Mark Fail</button>
        </div>

        <pre id="codeBlock"></pre>
        
        <div style="display:flex; flex-direction:column; gap:5px;">
             <label style="font-size:12px; font-weight:600; color:#64748b;">Live Response:</label>
             <div style="background:#f8fafc; padding:10px; border-radius:6px; border:1px solid #e2e8f0; height:150px; overflow-y:auto; font-family:monospace; font-size:12px;" id="modalOutput">Click 'Run Live Request' to see output...</div>
        </div>
    </div>
</div>

<script>
    let providersData = [];
    
    // STORAGE KEYS
    const STORAGE_HISTORY = "ai_pulse_history_v9";
    const STORAGE_SELECTION = "ai_pulse_selection_v9";
    const STORAGE_CUSTOM = "ai_pulse_custom_models_v9";

    // LOAD DATA
    let testHistory = JSON.parse(localStorage.getItem(STORAGE_HISTORY) || "{}");
    let savedSelection = JSON.parse(localStorage.getItem(STORAGE_SELECTION) || "{}");
    let customModels = JSON.parse(localStorage.getItem(STORAGE_CUSTOM) || "{}");
    
    let currentModalIdx = -1;

    // --- 1. INITIALIZATION ---
    window.addEventListener('DOMContentLoaded', async () => {
        try {
            const response = await fetch('sources.json');
            if (!response.ok) throw new Error("Network error");
            const data = await response.json();
            loadProviders(data.providers);
        } catch (e) {
            document.getElementById("btnLoadSource").style.display = "inline-flex";
            document.getElementById("errorAlert").style.display = "block";
            document.getElementById("tableBody").innerHTML = `<tr><td colspan="8" style="text-align:center; padding:30px; color:#94a3b8;">Please load sources.json</td></tr>`;
        }
    });

    function loadExternalSource(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = JSON.parse(e.target.result);
                if(!data.providers) throw new Error("No providers");
                loadProviders(data.providers);
                document.getElementById("errorAlert").style.display = "none";
                document.getElementById("btnLoadSource").style.display = "none";
            } catch (err) { alert("Invalid JSON"); }
        };
        reader.readAsText(file);
    }

    // --- 2. RENDER TABLE ---
    function loadProviders(providers) {
        providersData = providers;
        const tbody = document.getElementById("tableBody");
        tbody.innerHTML = "";

        providers.forEach((p, idx) => {
            const pid = p.id;
            const history = testHistory[pid] || {};
            
            // Merge JSON models with Custom Models
            const userModels = customModels[pid] || [];
            const allModels = [...new Set([...(p.models || []), ...userModels])];
            
            // Store merged list back in provider object for easier access
            p._allModels = allModels; 

            // Stats
            const passingCount = Object.values(history).filter(h => h.status === 'PASS').length;
            
            let lastPassDate = "--";
            const passes = Object.values(history).filter(h => h.status === 'PASS').map(h => h.date).sort().reverse();
            if (passes.length > 0) lastPassDate = passes[0];

            // Current Selection
            const currentModel = savedSelection[pid] || allModels[0] || "";

            // Datalist
            const dataListId = `list-${idx}`;
            const options = allModels.map(m => {
                const status = history[m] ? history[m].status : "NEVER";
                let icon = "‚ö™"; 
                if (status === "PASS") icon = "‚úÖ";
                if (status === "FAIL") icon = "‚ùå";
                return `<option value="${m}">${icon} ${m}</option>`;
            }).join("");

            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td><strong>${p.name}</strong></td>
                <td>
                    <div class="combo-container">
                        <input list="${dataListId}" id="model-${idx}" class="input-combo" value="${currentModel}" 
                               onchange="saveSelection('${pid}', this.value)" 
                               placeholder="Select model...">
                        <datalist id="${dataListId}">${options}</datalist>
                    </div>
                </td>
                <td><span id="status-${idx}" class="status-pill st-idle">Idle</span></td>
                <td id="lat-${idx}" style="font-family:monospace;">--</td>
                
                <td class="text-right"><strong>${allModels.length}</strong></td>
                <td class="text-right"><span class="stat-pass">${passingCount}</span></td>
                <td class="text-right"><span class="stat-date">${lastPassDate}</span></td>
                
                <td class="text-center">
                    <button class="btn btn-sm" onclick="openCodeModal(${idx})">üõ†Ô∏è Test</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    // --- 3. STATE MANAGEMENT ---
    function saveSelection(pid, val) {
        savedSelection[pid] = val;
        localStorage.setItem(STORAGE_SELECTION, JSON.stringify(savedSelection));
    }

    function recordTestResult(pid, model, status) {
        if (!testHistory[pid]) testHistory[pid] = {};
        testHistory[pid][model] = {
            status: status,
            date: new Date().toLocaleDateString() + " " + new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
        };
        localStorage.setItem(STORAGE_HISTORY, JSON.stringify(testHistory));
        loadProviders(providersData); // Refresh UI
    }

    function addNewModelFromModal() {
        if(currentModalIdx === -1) return;
        const p = providersData[currentModalIdx];
        const newVal = document.getElementById("modalModelInput").value.trim();
        
        if(!newVal) return alert("Please type a model ID.");
        
        // Save to Custom Models
        if(!customModels[p.id]) customModels[p.id] = [];
        if(!customModels[p.id].includes(newVal)) {
            customModels[p.id].push(newVal);
            localStorage.setItem(STORAGE_CUSTOM, JSON.stringify(customModels));
            alert(`Added "${newVal}" to ${p.name}`);
            
            // Reload everything to reflect changes
            loadProviders(providersData);
            
            // Update the modal's dropdown list immediately
            openCodeModal(currentModalIdx); 
            // Keep the value in input
            document.getElementById("modalModelInput").value = newVal;
        } else {
            alert("Model already exists in list.");
        }
    }

    // --- 4. SYSTEM CHECK ---
    async function runSystemCheck() {
        const btn = document.querySelector('.btn-primary');
        const oldText = btn.innerText;
        btn.innerText = "‚è≥ Running...";
        await Promise.all(providersData.map((_, idx) => runTest(idx)));
        btn.innerText = oldText;
    }

    async function runTest(idx) {
        const p = providersData[idx];
        const statusEl = document.getElementById(`status-${idx}`);
        const latEl = document.getElementById(`lat-${idx}`);
        const model = document.getElementById(`model-${idx}`).value;
        const key = p.key || ""; 

        if(!model) return;

        statusEl.className = "status-pill st-load"; statusEl.innerText = "Testing";
        const start = performance.now();
        try {
            const { url, headers, body } = buildRequest(p, model, key);
            const res = await fetch(url, { method: "POST", headers, body: JSON.stringify(body) });
            const duration = ((performance.now() - start) / 1000).toFixed(2);

            if (res.ok) {
                statusEl.className = "status-pill st-ok"; statusEl.innerText = "Online";
                latEl.innerText = duration + "s"; latEl.style.color = "green";
                recordTestResult(p.id, model, "PASS");
            } else {
                throw new Error(res.status);
            }
        } catch (e) {
            statusEl.className = "status-pill st-err"; statusEl.innerText = "Error";
            latEl.innerText = "Fail"; latEl.style.color = "red";
            recordTestResult(p.id, model, "FAIL");
        }
    }

    // --- 5. HELPER ---
    function buildRequest(p, model, key) {
        let url = p.endpoint.replace("{model}", model).replace("{key}", key);
        let headers = { "Content-Type": "application/json" };
        if (p.authType === "bearer" && key) headers["Authorization"] = `Bearer ${key}`;
        if (p.authType === "header-custom") {
            if (key) headers["x-api-key"] = key;
            if (p.customHeaders) Object.assign(headers, p.customHeaders);
        }
        let bStr = JSON.stringify(p.testBody).replace("{model}", model);
        return { url, headers, body: JSON.parse(bStr) };
    }

    // --- 6. MODAL & INTERACTION ---
    function openCodeModal(idx) {
        currentModalIdx = idx;
        const p = providersData[idx];
        
        // Use the model currently selected in the main table as default
        const currentSelection = document.getElementById(`model-${idx}`).value;
        
        // 1. Reset UI
        document.getElementById("modalOutput").innerText = "Click 'Run Live Request' to see output...";
        document.getElementById("modalStatus").innerText = "";
        document.getElementById("actionButtons").style.display = "none"; // HIDE BUTTONS INITIALLY
        
        // 2. Populate Dropdown
        const dataList = document.getElementById("modalModelList");
        dataList.innerHTML = "";
        p._allModels.forEach(m => {
            const opt = document.createElement("option");
            opt.value = m;
            dataList.appendChild(opt);
        });
        
        document.getElementById("modalModelInput").value = currentSelection;
        
        // 3. Generate Code Snippet
        updateSnippetFromInput();

        document.getElementById("codeModal").style.display = "flex";
    }

    function updateSnippetFromInput() {
        if(currentModalIdx === -1) return;
        const p = providersData[currentModalIdx];
        const model = document.getElementById("modalModelInput").value || "{model}";
        const { url, headers, body } = buildRequest(p, model, "YOUR_API_KEY");

        let code = `// ${p.name} - ${model}\n`;
        code += `const url = "${url}";\n`;
        code += `const headers = ${JSON.stringify(headers, null, 2)};\n`;
        code += `const body = ${JSON.stringify(body, null, 2)};\n\n`;
        code += `fetch(url, { method: "POST", headers, body: JSON.stringify(body) })\n`;
        code += `.then(res => res.json()).then(console.log);`;
        
        document.getElementById("codeBlock").innerText = code;
    }

    function markModelStatus(status) {
        if (currentModalIdx === -1) return;
        const p = providersData[currentModalIdx];
        const model = document.getElementById("modalModelInput").value;
        
        recordTestResult(p.id, model, status);
        
        // Feedback
        const color = status === 'PASS' ? 'green' : 'red';
        document.getElementById("modalStatus").innerText = `Marked as ${status}`;
        document.getElementById("modalStatus").style.color = color;
    }

    async function runSingleTestFromModal() {
        if (currentModalIdx === -1) return;
        
        // Reset state
        document.getElementById("actionButtons").style.display = "none";
        document.getElementById("modalStatus").innerText = "";
        
        const p = providersData[currentModalIdx];
        const model = document.getElementById("modalModelInput").value;
        if(!model) return alert("Please select a model");
        
        const key = p.key || "";
        const out = document.getElementById("modalOutput");

        out.innerText = "‚è≥ Sending request...";
        try {
            const { url, headers, body } = buildRequest(p, model, key);
            const res = await fetch(url, { method: "POST", headers, body: JSON.stringify(body) });
            const json = await res.json();
            
            out.innerText = JSON.stringify(json, null, 2);
            const isSuccess = res.ok;
            
            document.getElementById("modalStatus").innerText = isSuccess ? "‚úÖ Response Received" : "‚ùå Error Response";
            document.getElementById("modalStatus").style.color = isSuccess ? "green" : "red";
            
            // SHOW BUTTONS NOW
            document.getElementById("actionButtons").style.display = "flex";

        } catch (e) {
            out.innerText = "Error: " + e.message;
            document.getElementById("modalStatus").innerText = "Network Failed";
            document.getElementById("modalStatus").style.color = "red";
            // Even on fail, user might want to mark fail explicitly
            document.getElementById("actionButtons").style.display = "flex";
        }
    }
</script>
</body>
</html>
